<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Departamento de Operaciones - Seguridad 24/7</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/gestion_operaciones.css" />
    <link rel="stylesheet" href="css/index.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    />
    <!-- Select2 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link rel="icon" href="assets/img/logo.ico" type="image/x-icon" />
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  </head>

  <body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
      <div class="container">
        <a class="navbar-brand" href="#">SEGURIDAD 24/7 ECUADOR</a>

        <button class="navbar-toggler" type="button" id="sidebarToggle">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div
          class="collapse navbar-collapse d-none d-lg-flex justify-content-end"
          id="navbarNav"
        >
          <button class="btn-logout-nav" id="logoutBtn">
            <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión
          </button>
        </div>
      </div>
    </nav>

    <div class="admin-wrapper">
      <!-- SIDEBAR -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
          <img src="assets/img/logo.png" alt="Logo" />
          <span class="admin-label">OPERACIONES</span>
        </div>

        <ul class="sidebar-menu">
          <li class="sidebar-item">
            <a class="sidebar-link active" data-view="dashboard">
              <i class="fa-solid fa-gauge-high"></i> Dashboard
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" data-view="complexes">
              <i class="fa-solid fa-building-shield"></i> Conjuntos
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" data-view="passwords">
              <i class="fa-solid fa-key"></i> Gestión de Claves
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" data-view="jobs">
              <i class="fa-solid fa-briefcase"></i> Trabajos
            </a>
          </li>
          <!-- Logout for mobile -->
          <li class="sidebar-item d-lg-none mt-4">
            <button class="btn-logout-nav w-100" id="logoutBtnMobile">
              <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión
            </button>
          </li>
        </ul>
      </aside>

      <!-- CONTENT -->
      <main class="main-content">
        <div class="container-fluid">
          <!-- Dashboard Section -->
          <div id="dashboardSection">
            <h1 class="mb-5">Panel de Control de Operaciones</h1>

            <!-- Welcome Profile Card -->
            <div class="row mb-5">
              <div class="col-12">
                <div class="stat-card" id="userProfileCard">
                  <div class="d-flex align-items-center gap-4">
                    <div
                      class="stat-card-icon"
                      style="
                        background: rgba(212, 175, 55, 0.1);
                        color: #d4af37;
                      "
                    >
                      <i class="fa-solid fa-user-gear fa-lg"></i>
                    </div>
                    <div>
                      <h4 id="userName" class="text-gold mb-0">Cargando...</h4>
                      <p id="userEmail" class="text-white-50 mb-0"></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-4 mb-5">
              <div class="col-xl-4 col-md-6">
                <div class="stat-card">
                  <div
                    class="stat-card-icon"
                    style="background: rgba(212, 175, 55, 0.1); color: #d4af37"
                  >
                    <i class="fa-solid fa-building"></i>
                  </div>
                  <div class="stat-card-info">
                    <h3 id="statTotalComplexes">0</h3>
                    <p>Conjuntos Registrados</p>
                  </div>
                </div>
              </div>
              <div class="col-xl-4 col-md-6">
                <div class="stat-card">
                  <div
                    class="stat-card-icon"
                    style="background: rgba(40, 167, 69, 0.1); color: #28a745"
                  >
                    <i class="fa-solid fa-user-check"></i>
                  </div>
                  <div class="stat-card-info">
                    <h3 id="statTotalAdmins">0</h3>
                    <p>Administradores de Conjunto</p>
                  </div>
                </div>
              </div>
              <div class="col-xl-4 col-md-6">
                <div class="stat-card">
                  <div
                    class="stat-card-icon"
                    style="background: rgba(52, 152, 219, 0.1); color: #3498db"
                  >
                    <i class="fa-solid fa-briefcase"></i>
                  </div>
                  <div class="stat-card-info">
                    <h3 id="statTotalJobs">0</h3>
                    <p>Trabajos Técnicos</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Complexes Section -->
          <div id="complexesSection" style="display: none">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2 class="text-gold">Listado de Conjuntos</h2>
              <button
                class="btn btn-gold"
                data-bs-toggle="modal"
                data-bs-target="#addComplexModal"
              >
                <i class="fa-solid fa-plus me-2"></i> Nuevo Conjunto
              </button>
            </div>

            <div class="row g-4" id="complexesGrid">
              <!-- Se cargará dinámicamente -->
              <div class="col-12 text-center py-5 text-muted">
                <i class="fa-solid fa-spinner fa-spin fa-2x mb-2"></i
                ><br />Cargando conjuntos...
              </div>
            </div>
          </div>

          <!-- Passwords Section (Read-Only) -->
          <div id="passwordsSection" style="display: none">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2 class="text-gold mb-0">Gestión de Claves Técnicas</h2>
              <!-- Sin botón de agregar (Sólo lectura) -->
            </div>

            <div class="mb-4">
              <input
                type="text"
                id="passwordSearchInput"
                class="form-control"
                placeholder="Buscar por conjunto o dispositivo..."
              />
            </div>

            <div
              id="passwordsContainer"
              class="row g-4"
              style="margin-top: 20px"
            >
              <p class="text-center text-muted">Cargando claves...</p>
            </div>
          </div>

          <!-- Jobs Section -->
          <div id="jobsSection" style="display: none">
            <div class="d-flex justify-content-between align-items-center mb-5">
              <h2 class="text-gold mb-0">Gestión de Trabajos</h2>
              <div class="d-flex gap-3 align-items-center">
                <select id="jobUrgencyFilter" class="modern-select">
                  <option value="todas">Urgencia: Todas</option>
                  <option value="Normal">Normal</option>
                  <option value="Urgente">Urgente</option>
                  <option value="Crítico">Crítico</option>
                </select>
                <input
                  type="text"
                  id="jobSearchInput"
                  class="modern-input"
                  placeholder="Buscar cliente..."
                />
                <button
                  class="btn btn-gold px-4"
                  data-bs-toggle="modal"
                  data-bs-target="#addJobModal"
                >
                  <i class="fa-solid fa-plus me-2"></i> Crear Trabajo
                </button>
              </div>
            </div>

            <div id="jobsContainer" class="row g-4">
              <p class="text-center text-muted">Cargando trabajos...</p>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- MODAL AGREGAR CONJUNTO -->
    <div
      class="modal fade"
      id="addComplexModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Registrar Conjunto</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body p-4">
            <form id="addComplexForm">
              <div class="mb-3">
                <div
                  class="d-flex justify-content-between align-items-center mb-1"
                >
                  <label class="form-label mb-0"
                    >REPRESENTANTE / ADMINISTRADOR</label
                  >
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="toggleAdminManual"
                      style="cursor: pointer"
                    />
                    <label
                      class="form-check-label small text-white-50"
                      for="toggleAdminManual"
                      style="cursor: pointer; font-size: 0.7rem"
                    >
                      No registrado aún
                    </label>
                  </div>
                </div>

                <div id="adminLinkWrapper">
                  <select id="complexAdmin" class="form-select select2-admin">
                    <option value="" disabled selected>
                      Seleccione un administrador...
                    </option>
                  </select>
                </div>

                <div id="adminManualWrapper" style="display: none">
                  <input
                    type="text"
                    id="complexAdminManual"
                    class="form-control force-uppercase"
                    placeholder="Escriba el nombre del administrador"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">NOMBRE DEL CONJUNTO</label>
                <input
                  type="text"
                  id="complexName"
                  class="form-control force-uppercase"
                  placeholder="Ej: Urbanización Los Pinos"
                  required
                />
              </div>
              <div class="d-grid mt-4">
                <button type="submit" class="btn btn-gold">
                  <i class="fa-solid fa-save me-2"></i> GUARDAR CONJUNTO
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL VER REGISTROS -->
    <div
      class="modal fade"
      id="viewRegistriesModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div
        class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable"
      >
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title d-flex align-items-center flex-wrap">
              <i class="fa-solid fa-clipboard-list me-2"></i>
              <span>Registros de&nbsp;</span>
              <span id="registriesComplexName" class="fw-bold"></span>
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body p-4">
            <div id="registriesTableContainer">
              <div class="text-center py-5">
                <i class="fa-solid fa-spinner fa-spin fa-2x text-gold mb-3"></i>
                <p class="text-muted">Cargando registros...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL EDITAR REGISTRO -->
    <div
      class="modal fade"
      id="editRegistryModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fa-solid fa-pen-to-square text-white me-2"></i>
              Editar Registro de Residente
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body p-4">
            <form id="editRegistryForm">
              <input type="hidden" id="editRegId" />
              <input type="hidden" id="editRegComplexName" />

              <div class="row g-3 mb-4">
                <div class="col-md-7">
                  <label class="form-label">CASA / DEPARTAMENTO #</label>
                  <input
                    type="text"
                    id="editRegHouseNum"
                    class="form-control force-uppercase"
                    placeholder="Ej: Villa 05"
                    required
                  />
                </div>
                <div class="col-md-5">
                  <label class="form-label">TIPO</label>
                  <select id="editRegResType" class="form-select" required>
                    <option value="propietario">Propietario</option>
                    <option value="arrendatario">Arrendatario</option>
                  </select>
                </div>
              </div>

              <div class="mb-4">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <h6 class="text-gold mb-0 fw-bold">
                    <i class="fa-solid fa-users me-2"></i> Residentes
                  </h6>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-gold"
                    onclick="addResidentEntryEdit()"
                  >
                    <i class="fa-solid fa-plus me-1"></i> Añadir
                  </button>
                </div>
                <div
                  id="editResidentsContainer"
                  class="d-flex flex-column gap-3"
                ></div>
              </div>

              <div class="mb-4">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <h6 class="text-gold mb-0 fw-bold">
                    <i class="fa-solid fa-car me-2"></i> Vehículos
                  </h6>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-gold"
                    onclick="addVehicleEntryEdit()"
                  >
                    <i class="fa-solid fa-plus me-1"></i> Añadir
                  </button>
                </div>
                <div
                  id="editVehiclesContainer"
                  class="d-flex flex-column gap-3"
                ></div>
              </div>

              <div class="d-grid mt-4">
                <button type="submit" class="btn btn-gold">
                  <i class="fa-solid fa-save me-2"></i> ACTUALIZAR REGISTRO
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL AGREGAR TRABAJO -->
    <div class="modal fade" id="addJobModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Agregar Trabajo</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body p-4">
            <form id="addJobForm">
              <div class="mb-3">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <label class="form-label mb-0"
                    >Nombre del Cliente (Conjunto)</label
                  >
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-gold"
                    data-bs-toggle="modal"
                    data-bs-target="#addComplexModal"
                    style="
                      --bs-btn-padding-y: 0.1rem;
                      --bs-btn-padding-x: 0.4rem;
                      --bs-btn-font-size: 0.75rem;
                    "
                  >
                    <i class="fa-solid fa-plus me-1"></i> Nuevo Conjunto
                  </button>
                </div>
                <select
                  id="clientName"
                  class="form-select select2-complex"
                  required
                >
                  <option value="" disabled selected>
                    Seleccione un conjunto...
                  </option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Fecha de Publicación</label>
                <input type="date" class="form-control" id="jobDate" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Estado de Urgencia</label>
                <select class="form-select" id="jobUrgency" required>
                  <option value="Normal">Normal</option>
                  <option value="Urgente">Urgente</option>
                  <option value="Crítico">Crítico</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Nombre de Contacto</label>
                <input
                  type="text"
                  class="form-control force-uppercase"
                  id="contactName"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Número de Contacto</label>
                <input
                  type="text"
                  class="form-control"
                  id="contactPhone"
                  required
                />
              </div>
              <div class="d-grid mt-4">
                <button type="submit" class="btn btn-gold">
                  <i class="fa-solid fa-save me-2"></i> GUARDAR TRABAJO
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL EDITAR TRABAJO -->
    <div class="modal fade" id="editJobModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar Trabajo</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body p-4">
            <form id="editJobForm">
              <input type="hidden" id="editJobId" />
              <div class="mb-3">
                <label class="form-label">Nombre del Cliente (Conjunto)</label>
                <select
                  id="editClientName"
                  class="form-select select2-complex"
                  required
                >
                  <option value="" disabled selected>
                    Seleccione un conjunto...
                  </option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Fecha de Publicación</label>
                <input
                  type="date"
                  class="form-control"
                  id="editJobDate"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Estado de Urgencia</label>
                <select class="form-select" id="editJobUrgency" required>
                  <option value="Normal">Normal</option>
                  <option value="Urgente">Urgente</option>
                  <option value="Crítico">Crítico</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Nombre de Contacto</label>
                <input
                  type="text"
                  class="form-control force-uppercase"
                  id="editContactName"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Número de Contacto</label>
                <input
                  type="text"
                  class="form-control"
                  id="editContactPhone"
                  required
                />
              </div>
              <div class="d-grid mt-4">
                <button type="submit" class="btn btn-gold">
                  <i class="fa-solid fa-save me-2"></i> ACTUALIZAR TRABAJO
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL VER REPORTE -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-report-content">
          <div class="modal-header">
            <h5 class="modal-title">Informe Técnico de Trabajo</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body p-4" id="reportContentArea">
            <div class="report-grid">
              <!-- Detalles del Trabajo -->
              <div class="report-card">
                <div class="report-card-title">
                  <i class="fa-solid fa-briefcase"></i> Detalles del Trabajo
                </div>
                <div class="report-info-item">
                  <span class="report-info-label">Cliente:</span>
                  <span class="report-info-value" id="reportClientName"></span>
                </div>
                <div class="report-info-item">
                  <span class="report-info-label">Asignación:</span>
                  <span class="report-info-value" id="reportJobDate"></span>
                </div>
              </div>

              <!-- Detalles del Informe -->
              <div class="report-card">
                <div class="report-card-title">
                  <i class="fa-solid fa-clipboard-check"></i> Detalles del
                  Informe
                </div>
                <div class="report-info-item">
                  <span class="report-info-label">Estado:</span>
                  <span
                    class="report-info-value text-gold"
                    id="reportStatus"
                  ></span>
                </div>
                <div class="report-info-item">
                  <span class="report-info-label">Finalizado:</span>
                  <span class="report-info-value">
                    <span id="reportDate"></span> -
                    <span id="reportTime"></span>
                  </span>
                </div>
              </div>
            </div>

            <!-- Informe de Trabajo Realizado -->
            <div class="report-card mb-4">
              <div class="report-card-title">
                <i class="fa-solid fa-pen-fancy"></i> Informe de Trabajo
                Realizado
              </div>
              <div id="reportText" class="report-text-area"></div>
            </div>

            <!-- Evidencia Fotográfica -->
            <div class="report-card mb-4">
              <div class="report-card-title">
                <i class="fa-solid fa-images"></i> Evidencia Fotográfica
              </div>
              <div class="report-evidence-grid">
                <div class="report-img-container">
                  <img id="reportImage1" src="" alt="Evidencia 1" />
                </div>
                <div class="report-img-container">
                  <img id="reportImage2" src="" alt="Evidencia 2" />
                </div>
              </div>
            </div>

            <!-- Firmas -->
            <div id="reportSignaturesSection" style="display: none">
              <div class="report-card">
                <div class="report-card-title">
                  <i class="fa-solid fa-file-signature"></i> Firmas de
                  Conformidad
                </div>
                <div class="report-signature-grid">
                  <div class="text-center">
                    <small class="text-gold d-block mb-2">Sello Técnico</small>
                    <div class="signature-box">
                      <img src="assets/img/firma.png" alt="Sello Técnico" />
                    </div>
                  </div>
                  <div class="text-center">
                    <small class="text-gold d-block mb-2">Firma Cliente</small>
                    <div class="signature-box">
                      <img
                        id="reportClientSignature"
                        src=""
                        alt="Firma del Cliente"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-report-footer">
            <button
              type="button"
              class="btn-pdf-premium"
              id="generateJobPdfBtn"
            >
              <i class="fa-solid fa-file-pdf me-2"></i> Descargar Informe PDF
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- FOOTER -->
    <footer class="footer">
      © 2025 Seguridad 24/7 Ecuador &
      <a
        href="https://mallitaxicodevision.netlify.app/"
        target="_blank"
        rel="noopener noreferrer"
        class="footer-link"
      >
        MCV (Mallitaxi Code Vision)
      </a>
      — Todos los derechos reservados
    </footer>

    <!-- SCRIPTS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="js/firebase.js"></script>
    <script src="js/sweetalert2.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Auth check
        auth.onAuthStateChanged(async (user) => {
          if (!user) {
            window.location.href = "control_center.html";
            return;
          }

          const doc = await db.collection("users").doc(user.uid).get();
          const userData = doc.exists ? doc.data() : null;
          const role = userData ? userData.role : "";

          if (role !== "operaciones" && role !== "monitoreo") {
            window.location.href = "control_center.html";
            return;
          }

          document.getElementById("userName").textContent =
            userData.adminName || userData.nombre || "Operador";
          document.getElementById("userEmail").textContent = user.email;

          cargarEstadisticas();
          cargarConjuntos();
        });

        // Sidebar Navigation
        const sidebarLinks = document.querySelectorAll(".sidebar-link");
        const sections = [
          "dashboardSection",
          "complexesSection",
          "passwordsSection",
          "jobsSection",
        ];

        sidebarLinks.forEach((link) => {
          link.addEventListener("click", (e) => {
            const view = link.getAttribute("data-view");
            sidebarLinks.forEach((l) => l.classList.remove("active"));
            link.classList.add("active");

            sections.forEach((s) => {
              const el = document.getElementById(s);
              if (el) el.style.display = "none";
            });

            const target = document.getElementById(view + "Section");
            if (target) target.style.display = "block";

            // Si es la vista de claves, cargar datos
            if (view === "passwords") {
              if (!window.passwordsLoaded) cargarClavesTecnicas();
              else renderClavesTecnicas(window.allPasswords);
            }

            if (view === "jobs") {
              cargarTrabajos();
            }

            const sidebar = document.getElementById("sidebar");
            if (window.innerWidth <= 991) sidebar.classList.remove("show");
          });
        });

        // --- SELECT2 Y CARGA DE ADMINISTRADORES ---
        function formatAdminResult(admin) {
          if (!admin.id || !admin.element) return admin.text;
          const complex = $(admin.element).data("complex");
          return $(`
                <div class="p-1">
                    <div style="color: #d4af37; font-weight: 700; font-size: 0.95rem;">${
                      admin.text
                    }</div>
                    <div style="color: rgba(255,255,255,0.5); font-size: 0.75rem; margin-top: 2px;">
                        <i class="fa-solid fa-building me-1"></i> ${
                          complex || "Sin conjunto asignado"
                        }
                    </div>
                </div>
            `);
        }

        async function cargarOpcionesSelect2() {
          try {
            const snapshot = await db
              .collection("users")
              .where("role", "==", "ADMIN_CONJUNTO")
              .get();
            const select = $("#complexAdmin");
            select
              .empty()
              .append(
                '<option value="" disabled selected>Seleccione un administrador...</option>'
              );

            snapshot.forEach((doc) => {
              const data = doc.data();
              const name = data.adminName || data.name || "Sin nombre";
              const complex = data.complexName || "No asignado";
              const option = new Option(name, name, false, false);
              $(option).attr("data-complex", complex);
              select.append(option);
            });

            $(".select2-admin")
              .select2({
                dropdownParent: $("#addComplexModal"),
                width: "100%",
                templateResult: formatAdminResult,
                templateSelection: (state) => state.text,
              })
              .on("select2:select", function (e) {
                const data = e.params.data;
                const complexName = $(data.element).data("complex");
                if (complexName && complexName !== "No asignado") {
                  $("#complexName").val(complexName);
                }
              });

            // Lógica para toggle de administrador manual
            document
              .getElementById("toggleAdminManual")
              .addEventListener("change", function (e) {
                const manualWrapper =
                  document.getElementById("adminManualWrapper");
                const linkWrapper = document.getElementById("adminLinkWrapper");
                const manualInput =
                  document.getElementById("complexAdminManual");

                if (e.target.checked) {
                  manualWrapper.style.display = "block";
                  linkWrapper.style.display = "none";
                  manualInput.setAttribute("required", "required");
                } else {
                  manualWrapper.style.display = "none";
                  linkWrapper.style.display = "block";
                  manualInput.removeAttribute("required");
                }
              });
          } catch (error) {
            console.error("Error cargando admins para Select2:", error);
          }
        }

        // CARGAR CONJUNTOS PARA SELECTS DE TRABAJOS
        async function cargarConjuntosParaSelects(targetValue = null) {
          try {
            const snapshot = await db
              .collection("complexes")
              .orderBy("name", "asc")
              .get();
            const selects = $(".select2-complex");

            selects.each(function () {
              const $el = $(this);
              const currentVal = $el.val();
              $el
                .empty()
                .append(
                  '<option value="" disabled selected>Seleccione un conjunto...</option>'
                );

              snapshot.forEach((doc) => {
                const data = doc.data();
                $el.append(new Option(data.name, data.name));
              });

              if (targetValue) {
                $el.val(targetValue).trigger("change");
              } else if (currentVal) {
                $el.val(currentVal).trigger("change");
              }
            });

            // Inicializar Select2 si no está inicializado
            $(".select2-complex").select2({
              width: "100%",
              dropdownParent: function (el) {
                return $(el).closest(".modal");
              },
            });
          } catch (error) {
            console.error("Error cargando conjuntos para selects:", error);
          }
        }

        cargarOpcionesSelect2();
        cargarConjuntosParaSelects();

        async function cargarEstadisticas() {
          const complexesSnap = await db.collection("complexes").get();
          document.getElementById("statTotalComplexes").textContent =
            complexesSnap.size;

          const adminsSnap = await db
            .collection("users")
            .where("role", "==", "ADMIN_CONJUNTO")
            .get();
          document.getElementById("statTotalAdmins").textContent =
            adminsSnap.size;

          const jobsSnap = await db.collection("trabajos").get();
          const realJobsCount = jobsSnap.docs.filter(
            (doc) => !doc.data().isGuide
          ).length;
          document.getElementById("statTotalJobs").textContent = realJobsCount;
        }

        async function cargarConjuntos() {
          const container = document.getElementById("complexesGrid");
          if (!container) return;
          try {
            const snapshot = await db
              .collection("complexes")
              .orderBy("createdAt", "desc")
              .get();
            container.innerHTML = "";
            if (snapshot.empty) {
              container.innerHTML =
                '<div class="col-12 text-center py-5 text-white-50">No hay conjuntos registrados aún.</div>';
              return;
            }
            snapshot.forEach((doc) => {
              const data = doc.data();
              const card = `
                        <div class="col-xl-3 col-lg-4 col-md-6">
                            <div class="stat-card" style="display: block; height: auto; padding: 20px; border-radius: 15px;">
                                <div class="text-center mb-3">
                                    <div style="width: 50px; height: 50px; background: rgba(212,175,55,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; border: 1px solid rgba(212,175,55,0.3);">
                                        <i class="fa-solid fa-building" style="font-size: 1.3rem; color: #d4af37;"></i>
                                    </div>
                                </div>
                                <h5 class="text-gold mb-2 text-center text-truncate" style="font-size: 1rem; font-weight: 700;">${data.name}</h5>
                                <div class="text-center mb-3" style="padding: 8px; background: rgba(255,255,255,0.02); border-radius: 8px;">
                                    <i class="fa-solid fa-user-shield text-gold me-1" style="font-size: 0.75rem;"></i>
                                    <span class="small text-white-50" style="font-size: 0.75rem;">${data.admin}</span>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-gold w-100 py-2" onclick="verRegistros('${data.name}')" style="font-size: 0.75rem; border-radius: 8px;">
                                        <i class="fa-solid fa-clipboard-list me-1"></i> Registros
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="eliminarConjunto('${doc.id}')" title="Eliminar" style="width: 45px; border-radius: 8px;">
                                        <i class="fa-solid fa-trash" style="font-size: 0.8rem;"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
              container.innerHTML += card;
            });
          } catch (error) {
            console.error("Error al cargar conjuntos:", error);
            container.innerHTML =
              '<div class="col-12 text-center py-5 text-danger">Error al cargar la lista.</div>';
          }
        }

        // Nueva función para ver registros
        window.verRegistros = async (complexName) => {
          document.getElementById("registriesComplexName").textContent =
            complexName;
          const modal = new bootstrap.Modal(
            document.getElementById("viewRegistriesModal")
          );
          modal.show();

          const container = document.getElementById("registriesTableContainer");

          try {
            const snapshot = await db
              .collection("residents_registry")
              .where("complexName", "==", complexName)
              .get();

            if (snapshot.empty) {
              container.innerHTML = `
                <div class="text-center py-5">
                  <i class="fa-solid fa-inbox fa-3x text-muted mb-3"></i>
                  <p class="text-muted">No hay registros para este conjunto aún.</p>
                </div>
              `;
              return;
            }

            // Convertir a array y ordenar por fecha (más reciente primero)
            const registros = [];
            snapshot.forEach((doc) => {
              registros.push({ id: doc.id, ...doc.data() });
            });
            registros.sort((a, b) => {
              const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
              const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
              return dateB - dateA;
            });

            let tableHTML = `
              <div class="table-responsive">
                <table class="table table-dark-premium table-hover align-middle">
                  <thead>
                    <tr>
                      <th class="text-center">Vivienda</th>
                      <th class="text-center">Tipo</th>
                      <th class="text-center">Residente(s)</th>
                      <th class="text-center">Teléfono/WhatsApp</th>
                      <th class="text-center">Marca</th>
                      <th class="text-center">Modelo</th>
                      <th class="text-center">Color</th>
                      <th class="text-center">Placa</th>
                      <th class="text-center">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
            `;

            registros.forEach((data) => {
              const maxRows = Math.max(
                data.residents ? data.residents.length : 0,
                data.vehicles ? data.vehicles.length : 0,
                1
              );

              // Flag to handle cases with 1 vehicle but multiple residents (rowspan)
              const singleVehicleMultipleResidents =
                data.vehicles &&
                data.vehicles.length === 1 &&
                data.residents &&
                data.residents.length > 1;

              for (let i = 0; i < maxRows; i++) {
                const resident =
                  data.residents && data.residents[i]
                    ? data.residents[i]
                    : null;
                const vehicle =
                  data.vehicles && data.vehicles[i] ? data.vehicles[i] : null;

                tableHTML += `<tr>`;

                if (i === 0) {
                  tableHTML += `
                          <td class="text-center fw-bold text-gold" rowspan="${maxRows}">${
                    data.houseNum
                  }</td>
                          <td class="text-center align-middle" rowspan="${maxRows}">
                            <span class="badge ${
                              data.resType === "PROPIETARIO"
                                ? "bg-gold text-dark"
                                : "bg-outline-gold"
                            }">
                              ${data.resType || "PROPIETARIO"}
                            </span>
                          </td>
                        `;
                }

                if (resident) {
                  tableHTML += `
                          <td class="text-center align-middle">${resident.name} ${resident.lastname}</td>
                        `;
                } else if (i < maxRows) {
                  tableHTML += `<td class="text-center text-muted">-</td>`;
                }

                if (resident && resident.phone) {
                  const cleanPhone = resident.phone.replace(/\D/g, "");
                  const residentName = resident.name || "";
                  const whatsappMessage = encodeURIComponent(
                    `Hola ${residentName}, le saludamos de Seguridad 24/7 Ecuador.`
                  );
                  tableHTML += `
                          <td class="text-center">
                            <div class="d-flex align-items-center justify-content-center gap-2">
                              <span style="font-size: 0.85rem;">${resident.phone}</span>
                              <a href="https://wa.me/${cleanPhone}?text=${whatsappMessage}" target="_blank" class="text-success contact-icon">
                                <i class="fa-brands fa-whatsapp"></i>
                              </a>
                              <a href="tel:${resident.phone}" class="text-info contact-icon">
                                <i class="fa-solid fa-phone" style="font-size: 0.8rem;"></i>
                              </a>
                            </div>
                          </td>
                        `;
                } else if (i < maxRows) {
                  tableHTML += `<td class="text-center text-muted">-</td>`;
                }

                // VEHICULO INDIVIDUAL COLUMNS
                if (singleVehicleMultipleResidents && i === 0) {
                  const v = data.vehicles[0];
                  tableHTML += `
                          <td class="text-center fw-bold" rowspan="${maxRows}">${v.brand}</td>
                          <td class="text-center" rowspan="${maxRows}">${v.model}</td>
                          <td class="text-center" rowspan="${maxRows}">${v.color}</td>
                          <td class="text-center text-gold-premium" rowspan="${maxRows}">${v.plate}</td>
                        `;
                } else if (!singleVehicleMultipleResidents) {
                  if (vehicle) {
                    tableHTML += `
                            <td class="text-center fw-bold">${vehicle.brand}</td>
                            <td class="text-center">${vehicle.model}</td>
                            <td class="text-center">${vehicle.color}</td>
                            <td class="text-center text-gold-premium">${vehicle.plate}</td>
                          `;
                  } else if (i < maxRows) {
                    tableHTML += `
                            <td class="text-center text-muted">-</td>
                            <td class="text-center text-muted">-</td>
                            <td class="text-center text-muted">-</td>
                            <td class="text-center text-muted">-</td>
                          `;
                  }
                }

                // ACCIONES
                if (i === 0) {
                  tableHTML += `
                          <td class="text-center align-middle" rowspan="${maxRows}">
                            <div class="d-flex flex-column gap-1">
                              <button class="btn-action-table btn-edit-registry" onclick="abrirEditarRegistro('${data.id}')" title="Editar">
                                <i class="fa-solid fa-pen-to-square"></i>
                              </button>
                              <button class="btn-action-table btn-delete-registry" onclick="eliminarRegistro('${data.id}', '${complexName}')" title="Eliminar">
                                <i class="fa-solid fa-trash-can"></i>
                              </button>
                            </div>
                          </td>
                        `;
                }

                tableHTML += `</tr>`;
              }
            });

            tableHTML += `
                  </tbody>
                </table>
              </div>
            `;

            container.innerHTML = tableHTML;
          } catch (error) {
            console.error("Error al cargar registros:", error);
            container.innerHTML = `
              <div class="alert alert-danger">
                <i class="fa-solid fa-exclamation-triangle me-2"></i>
                Error al cargar los registros. Por favor, intenta de nuevo.
              </div>
            `;
          }
        };

        // --- FUNCIONES PARA EDITAR Y ELIMINAR REGISTROS ---

        window.addResidentEntryEdit = (data = null) => {
          const container = document.getElementById("editResidentsContainer");
          const div = document.createElement("div");
          div.className =
            "p-3 rounded border border-secondary border-opacity-25 position-relative bg-dark bg-opacity-25";
          div.innerHTML = `
            <button type="button" class="btn-close btn-close-white position-absolute end-0 top-0 m-2" onclick="this.parentElement.remove()" style="font-size: 0.6rem;"></button>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label-gold mb-1" style="font-size: 0.65rem;">NOMBRE</label>
                <input type="text" class="form-control resident-name py-1" value="${
                  data ? data.name : ""
                }" required />
              </div>
              <div class="col-6">
                <label class="form-label-gold mb-1" style="font-size: 0.65rem;">APELLIDO</label>
                <input type="text" class="form-control resident-lastname py-1" value="${
                  data ? data.lastname : ""
                }" required />
              </div>
              <div class="col-12">
                <label class="form-label-gold mb-1" style="font-size: 0.65rem;">TELÉFONO</label>
                <input type="tel" class="form-control resident-phone py-1" value="${
                  data ? data.phone : ""
                }" required />
              </div>
            </div>
          `;
          container.appendChild(div);
        };

        window.addVehicleEntryEdit = (data = null) => {
          const container = document.getElementById("editVehiclesContainer");
          const div = document.createElement("div");
          div.className =
            "p-3 rounded border border-secondary border-opacity-25 position-relative bg-dark bg-opacity-25";
          div.innerHTML = `
            <button type="button" class="btn-close btn-close-white position-absolute end-0 top-0 m-2" onclick="this.parentElement.remove()" style="font-size: 0.6rem;"></button>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label-gold mb-1" style="font-size: 0.65rem;">MARCA</label>
                <input type="text" class="form-control v-brand py-1" value="${
                  data ? data.brand : ""
                }" required />
              </div>
              <div class="col-6">
                <label class="form-label-gold mb-1" style="font-size: 0.65rem;">MODELO</label>
                <input type="text" class="form-control v-model py-1" value="${
                  data ? data.model : ""
                }" required />
              </div>
              <div class="col-6">
                <label class="form-label-gold mb-1" style="font-size: 0.65rem;">COLOR</label>
                <input type="text" class="form-control v-color py-1" value="${
                  data ? data.color : ""
                }" required />
              </div>
              <div class="col-6">
                <label class="form-label-gold mb-1" style="font-size: 0.65rem;">PLACA</label>
                <input type="text" class="form-control v-plate py-1" value="${
                  data ? data.plate : ""
                }" required />
              </div>
            </div>
          `;
          container.appendChild(div);
        };

        window.abrirEditarRegistro = async (id) => {
          Swal.fire({
            title: "Cargando datos...",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          try {
            const doc = await db.collection("residents_registry").doc(id).get();
            const data = doc.data();

            document.getElementById("editRegId").value = id;
            document.getElementById("editRegComplexName").value =
              data.complexName;
            document.getElementById("editRegHouseNum").value = data.houseNum;
            document.getElementById("editRegResType").value =
              data.resType || "propietario";

            const residentsContainer = document.getElementById(
              "editResidentsContainer"
            );
            residentsContainer.innerHTML = "";
            if (data.residents && data.residents.length > 0) {
              data.residents.forEach((r) => addResidentEntryEdit(r));
            } else {
              addResidentEntryEdit();
            }

            const vehiclesContainer = document.getElementById(
              "editVehiclesContainer"
            );
            vehiclesContainer.innerHTML = "";
            if (data.vehicles && data.vehicles.length > 0) {
              data.vehicles.forEach((v) => addVehicleEntryEdit(v));
            }

            Swal.close();
            const editModal = new bootstrap.Modal(
              document.getElementById("editRegistryModal")
            );
            editModal.show();
          } catch (error) {
            console.error("Error al abrir edición:", error);
            Swal.fire("Error", "No se pudieron cargar los datos.", "error");
          }
        };

        window.eliminarRegistro = (id, complexName) => {
          Swal.fire({
            title: "¿Estás seguro?",
            text: "Esta acción eliminará el registro de forma permanente.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#dc3545",
            cancelButtonColor: "#6c757d",
            confirmButtonText: "Sí, eliminar",
            cancelButtonText: "Cancelar",
          }).then(async (result) => {
            if (result.isConfirmed) {
              try {
                await db.collection("residents_registry").doc(id).delete();
                Swal.fire(
                  "¡Eliminado!",
                  "El registro ha sido eliminado.",
                  "success"
                );
                verRegistros(complexName); // Refrescar tabla
              } catch (error) {
                console.error("Error al eliminar registro:", error);
                Swal.fire("Error", "No se pudo eliminar el registro.", "error");
              }
            }
          });
        };

        document
          .getElementById("editRegistryForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = document.getElementById("editRegId").value;
            const complexName =
              document.getElementById("editRegComplexName").value;

            const residents = [];
            document
              .querySelectorAll("#editResidentsContainer > div")
              .forEach((div) => {
                residents.push({
                  name: div
                    .querySelector(".resident-name")
                    .value.trim()
                    .toUpperCase(),
                  lastname: div
                    .querySelector(".resident-lastname")
                    .value.trim()
                    .toUpperCase(),
                  phone: div.querySelector(".resident-phone").value.trim(),
                });
              });

            const vehicles = [];
            document
              .querySelectorAll("#editVehiclesContainer > div")
              .forEach((div) => {
                vehicles.push({
                  brand: div
                    .querySelector(".v-brand")
                    .value.trim()
                    .toUpperCase(),
                  model: div
                    .querySelector(".v-model")
                    .value.trim()
                    .toUpperCase(),
                  color: div
                    .querySelector(".v-color")
                    .value.trim()
                    .toUpperCase(),
                  plate: div
                    .querySelector(".v-plate")
                    .value.trim()
                    .toUpperCase(),
                });
              });

            Swal.fire({
              title: "Actualizando...",
              allowOutsideClick: false,
              didOpen: () => Swal.showLoading(),
            });

            try {
              await db
                .collection("residents_registry")
                .doc(id)
                .update({
                  houseNum: document
                    .getElementById("editRegHouseNum")
                    .value.toUpperCase(),
                  resType: document
                    .getElementById("editRegResType")
                    .value.toUpperCase(),
                  residents,
                  vehicles,
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                });

              Swal.fire(
                "¡Éxito!",
                "Registro actualizado correctamente.",
                "success"
              );
              bootstrap.Modal.getInstance(
                document.getElementById("editRegistryModal")
              ).hide();
              verRegistros(complexName); // Refrescar tabla
            } catch (error) {
              console.error("Error al actualizar:", error);
              Swal.fire("Error", "No se pudo actualizar el registro.", "error");
            }
          });

        document
          .getElementById("addComplexForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = document
              .getElementById("complexName")
              .value.trim()
              .toUpperCase();
            const isManual =
              document.getElementById("toggleAdminManual").checked;
            const admin = (
              isManual
                ? document.getElementById("complexAdminManual").value.trim()
                : document.getElementById("complexAdmin").value || ""
            ).toUpperCase();
            Swal.fire({
              title: "Guardando...",
              allowOutsideClick: false,
              didOpen: () => Swal.showLoading(),
            });
            try {
              await db.collection("complexes").add({
                name: name,
                admin,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
              Swal.fire(
                "¡Éxito!",
                "El conjunto ha sido registrado correctamente.",
                "success"
              );

              const modal = bootstrap.Modal.getInstance(
                document.getElementById("addComplexModal")
              );
              modal.hide();

              // Refrescar todos los selects de conjuntos y seleccionar el nuevo
              cargarConjuntosParaSelects(name);

              // Reset UI del admin manual
              document.getElementById("toggleAdminManual").checked = false;
              document.getElementById("adminManualWrapper").style.display =
                "none";
              document.getElementById("adminLinkWrapper").style.display =
                "block";

              e.target.reset();
              $("#complexAdmin").val("").trigger("change");
              cargarConjuntos();
              cargarEstadisticas();
            } catch (error) {
              console.error("Error al guardar:", error);
              Swal.fire("Error", "No se pudo registrar.", "error");
            }
          });

        window.ingresarConjunto = (id, name) => {
          Swal.fire({
            title: "Accediendo...",
            text: `Ingresando al sistema de monitoreo de ${name}`,
            icon: "info",
            timer: 2000,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading(),
          }).then(() => {
            // Aquí podrías redirigir a una página de monitoreo real o abrir un panel específico
            Swal.fire(
              "Acceso Exitoso",
              `Conectado al servidor de video de ${name}`,
              "success"
            );
          });
        };

        window.eliminarConjunto = (id) => {
          Swal.fire({
            title: "¿Eliminar?",
            text: "No se puede deshacer.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d4af37",
            confirmButtonText: "Sí, eliminar",
          }).then(async (result) => {
            if (result.isConfirmed) {
              try {
                await db.collection("complexes").doc(id).delete();
                Swal.fire("Eliminado", "Borrado con éxito.", "success");
                cargarConjuntos();
                cargarEstadisticas();
              } catch (error) {
                console.error("Error al eliminar:", error);
                Swal.fire("Error", "No se pudo eliminar.", "error");
              }
            }
          });
        };

        // --- GESTIÓN DE CLAVES (SÓLO LECTURA) ---
        window.cargarClavesTecnicas = async () => {
          const container = document.getElementById("passwordsContainer");
          if (!container) return;
          container.innerHTML = `<p class="text-center text-white w-100">Cargando claves...</p>`;

          try {
            const query = await db
              .collection("device_passwords")
              .orderBy("complexName", "asc")
              .get();

            window.allPasswords = [];
            query.forEach((doc) => {
              window.allPasswords.push({ id: doc.id, ...doc.data() });
            });

            window.passwordsLoaded = true;
            renderClavesTecnicas(window.allPasswords);
          } catch (error) {
            console.error("Error al cargar claves:", error);
            container.innerHTML = `<p class="text-center text-danger w-100">Error al cargar las claves.</p>`;
          }
        };

        window.renderClavesTecnicas = (passwordsList) => {
          const container = document.getElementById("passwordsContainer");
          if (!container) return;
          container.innerHTML = "";

          if (passwordsList.length === 0) {
            container.innerHTML = `<p class="text-center text-white-50 w-100 mt-4">No se encontraron registros.</p>`;
            return;
          }

          passwordsList.forEach((pass) => {
            container.innerHTML += `
              <div class="col-md-6 col-lg-4">
                <div class="stat-card d-block h-100" style="padding: 25px; transform: none !important;">
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                      <h5 class="text-gold mb-1" style="font-weight: 700;">${
                        pass.complexName
                      }</h5>
                      <span class="badge bg-gold">Gestión Técnica</span>
                    </div>
                  </div>

                  <div class="bg-dark p-3 rounded mb-0" style="background: rgba(0,0,0,0.3) !important; border: 1px solid rgba(212,175,55,0.1);">
                    <div class="row g-2">
                      <div class="col-6">
                        <span class="text-white-50 x-small d-block">Citófono:</span>
                        <span class="text-white small font-monospace">${
                          pass.citofono || "---"
                        }</span>
                      </div>
                      <div class="col-6">
                        <span class="text-white-50 x-small d-block">DVR:</span>
                        <span class="text-white small font-monospace">${
                          pass.dvr || "---"
                        }</span>
                      </div>

                      <div class="col-12 border-top border-secondary my-2" style="opacity: 0.2;"></div>

                      <div class="col-6 border-end border-secondary pe-2" style="border-right-color: rgba(255,255,255,0.1) !important;">
                        <div class="mb-2">
                          <span class="text-white-50 x-small d-block">Wifi: ${
                            pass.wifiName || "N/A"
                          }</span>
                          <span class="text-gold small font-monospace">${
                            pass.wifiPass || "---"
                          }</span>
                        </div>
                        <div>
                          <span class="text-white-50 x-small d-block">Cámaras (${
                            pass.camBrand || "N/A"
                          }):</span>
                          <span class="text-white small font-monospace">${
                            pass.camPass || "---"
                          }</span>
                        </div>
                      </div>

                      <div class="col-6 ps-2">
                        <span class="text-white-50 x-small d-block">Observaciones:</span>
                        <div class="text-white-50 x-small" style="line-height:1.2; font-style: italic;">
                          ${
                            pass.notes ||
                            '<span class="text-muted">Sin notas</span>'
                          }
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          });
        };

        // --- GESTIÓN DE TRABAJOS (CRUD) ---
        window.allTrabajos = [];

        window.cargarTrabajos = async () => {
          const container = document.getElementById("jobsContainer");
          if (!container) return;
          container.innerHTML = `<p class="text-center text-white w-100">Cargando trabajos...</p>`;

          try {
            const query = await db
              .collection("trabajos")
              .orderBy("createdAt", "desc")
              .get();
            window.allTrabajos = [];
            query.forEach((doc) => {
              const data = doc.data();
              if (!data.isGuide) {
                window.allTrabajos.push({ id: doc.id, ...data });
              }
            });
            renderTrabajos(window.allTrabajos);
          } catch (error) {
            console.error("Error al cargar trabajos:", error);
            container.innerHTML = `<p class="text-center text-danger w-100">Error al cargar los trabajos.</p>`;
          }
        };

        window.renderTrabajos = (trabajosList) => {
          const container = document.getElementById("jobsContainer");
          if (!container) return;
          container.innerHTML = "";

          if (trabajosList.length === 0) {
            container.innerHTML = `<p class="text-center text-white-50 w-100 mt-4">No se encontraron trabajos.</p>`;
            return;
          }

          trabajosList.forEach((job) => {
            const urgencyClass =
              job.jobUrgency === "Normal"
                ? "badge-normal"
                : job.jobUrgency === "Urgente"
                ? "badge-urgente"
                : "badge-critico";

            container.innerHTML += `
              <div class="col-xl-4 col-md-6">
                <div class="job-card">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="text-gold mb-0 fw-bold">${job.clientName}</h5>
                    <span class="badge ${urgencyClass}">${job.jobUrgency}</span>
                  </div>
                  <div class="job-divider"></div>
                  <div class="mb-3 small">
                    <p class="mb-1"><i class="fa-solid fa-calendar-day text-gold me-2"></i><strong>Fecha:</strong> ${
                      job.jobDate
                    }</p>
                    <p class="mb-1"><i class="fa-solid fa-user-tag text-gold me-2"></i><strong>Contacto:</strong> ${
                      job.contactName
                    }</p>
                    <p class="mb-1"><i class="fa-solid fa-phone text-gold me-2"></i><strong>Teléfono:</strong> ${
                      job.contactPhone
                    }</p>
                    <p class="mb-0"><i class="fa-solid fa-circle-info text-gold me-2"></i><strong>Estado:</strong> <span class="fw-bold">${
                      job.status || "Pendiente"
                    }</span></p>
                  </div>

                  <div class="row g-2">
                    <div class="col-6">
                      <button class="btn-edit" onclick="abrirEditarTrabajo('${
                        job.id
                      }')">
                        <i class="fa-solid fa-pen-to-square me-1"></i> Editar
                      </button>
                    </div>
                    <div class="col-6">
                      <button class="btn-delete" onclick="eliminarTrabajo('${
                        job.id
                      }')">
                        <i class="fa-solid fa-trash me-1"></i> Borrar
                      </button>
                    </div>
                    ${
                      job.status === "Culminado"
                        ? `
                    <div class="col-12">
                      <button class="btn-view-report" onclick="verReporteTrabajo('${job.id}')">
                        <i class="fa-solid fa-file-lines me-1"></i> Ver Reporte
                      </button>
                    </div>
                    `
                        : ""
                    }
                  </div>
                </div>
              </div>
            `;
          });
        };

        // CRUD Actions
        document
          .getElementById("addJobForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const jobData = {
              clientName: ($("#clientName").val() || "").toUpperCase(),
              jobDate: document.getElementById("jobDate").value,
              jobUrgency: document.getElementById("jobUrgency").value,
              contactName: document
                .getElementById("contactName")
                .value.toUpperCase(),
              contactPhone: document.getElementById("contactPhone").value,
              status: "Pendiente",
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            };

            Swal.fire({
              title: "Guardando...",
              allowOutsideClick: false,
              didOpen: () => Swal.showLoading(),
            });

            try {
              await db.collection("trabajos").add(jobData);
              Swal.fire("¡Éxito!", "Trabajo creado correctamente.", "success");
              e.target.reset();
              bootstrap.Modal.getInstance(
                document.getElementById("addJobModal")
              ).hide();
              cargarTrabajos();
            } catch (error) {
              console.error(error);
              Swal.fire("Error", "No se pudo crear el trabajo.", "error");
            }
          });

        window.abrirEditarTrabajo = async (id) => {
          const doc = await db.collection("trabajos").doc(id).get();
          if (!doc.exists) return;
          const data = doc.data();
          document.getElementById("editJobId").value = id;
          $("#editClientName").val(data.clientName).trigger("change");
          document.getElementById("editJobDate").value = data.jobDate;
          document.getElementById("editJobUrgency").value = data.jobUrgency;
          document.getElementById("editContactName").value = data.contactName;
          document.getElementById("editContactPhone").value = data.contactPhone;
          new bootstrap.Modal(document.getElementById("editJobModal")).show();
        };

        document
          .getElementById("editJobForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = document.getElementById("editJobId").value;
            const updatedData = {
              clientName: ($("#editClientName").val() || "").toUpperCase(),
              jobDate: document.getElementById("editJobDate").value,
              jobUrgency: document.getElementById("editJobUrgency").value,
              contactName: document
                .getElementById("editContactName")
                .value.toUpperCase(),
              contactPhone: document.getElementById("editContactPhone").value,
            };

            Swal.fire({
              title: "Actualizando...",
              allowOutsideClick: false,
              didOpen: () => Swal.showLoading(),
            });

            try {
              await db.collection("trabajos").doc(id).update(updatedData);
              Swal.fire("¡Éxito!", "Trabajo actualizado.", "success");
              bootstrap.Modal.getInstance(
                document.getElementById("editJobModal")
              ).hide();
              cargarTrabajos();
            } catch (error) {
              console.error(error);
              Swal.fire("Error", "No se pudo actualizar.", "error");
            }
          });

        window.eliminarTrabajo = (id) => {
          Swal.fire({
            title: "¿Eliminar trabajo?",
            text: "Esta acción no se puede deshacer.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d4af37",
            confirmButtonText: "Sí, eliminar",
          }).then(async (result) => {
            if (result.isConfirmed) {
              await db.collection("trabajos").doc(id).delete();
              Swal.fire("Eliminado", "El trabajo ha sido borrado.", "success");
              cargarTrabajos();
            }
          });
        };

        window.verReporteTrabajo = async (id) => {
          Swal.fire({
            title: "Cargando reporte...",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });
          try {
            const doc = await db.collection("trabajos").doc(id).get();
            const data = doc.data();

            const completionDateTime = data.reportDate.toDate();
            document.getElementById("reportClientName").innerText =
              data.clientName;
            document.getElementById("reportJobDate").innerText = data.jobDate;
            document.getElementById("reportStatus").innerText = data.status;
            document.getElementById("reportDate").innerText =
              completionDateTime.toLocaleDateString();
            document.getElementById("reportTime").innerText =
              completionDateTime.toLocaleTimeString();
            document.getElementById("reportText").innerText = data.report;
            document.getElementById("reportImage1").src =
              data.evidenceBase64 && data.evidenceBase64[0]
                ? data.evidenceBase64[0]
                : "";
            document.getElementById("reportImage2").src =
              data.evidenceBase64 && data.evidenceBase64[1]
                ? data.evidenceBase64[1]
                : "";

            // Manejar Firmas
            const signaturesSection = document.getElementById(
              "reportSignaturesSection"
            );
            const signatureImg = document.getElementById(
              "reportClientSignature"
            );
            if (data.clientSignature) {
              signatureImg.src = data.clientSignature;
              signaturesSection.style.display = "block";
            } else {
              signatureImg.src = "";
              signaturesSection.style.display = "none";
            }

            Swal.close();
            new bootstrap.Modal(document.getElementById("reportModal")).show();
          } catch (error) {
            console.error(error);
            Swal.fire("Error", "No se pudo cargar el reporte.", "error");
          }
        };

        // PDF Generation Logic (Modern & Elegant Style)
        document
          .getElementById("generateJobPdfBtn")
          .addEventListener("click", () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const logo = new Image();
            const seal = new Image();
            logo.src = "assets/img/logo.png";
            seal.src = "assets/img/firma.png";

            let imagesLoaded = 0;
            const checkImages = () => {
              imagesLoaded++;
              if (imagesLoaded === 2) generatePDF();
            };
            logo.onload = checkImages;
            seal.onload = checkImages;
            logo.onerror = checkImages;
            seal.onerror = checkImages;

            function generatePDF() {
              const primaryColor = "#d4af37"; // Gold
              const secondaryColor = "#1a1a1a"; // Dark Gray/Black
              const lightBG = "#f8f9fa";

              // --- PAGE CONFIG ---
              const pageWidth = doc.internal.pageSize.getWidth();
              const pageHeight = doc.internal.pageSize.getHeight();
              const margin = 20;
              const contentWidth = pageWidth - margin * 2;

              // --- HEADER ---
              // Dark Header Background
              doc.setFillColor(secondaryColor);
              doc.rect(0, 0, pageWidth, 40, "F");

              // Gold accent line
              doc.setFillColor(primaryColor);
              doc.rect(0, 0, pageWidth, 4, "F");

              // Logo
              try {
                doc.addImage(logo, "PNG", margin, 10, 20, 20);
              } catch (e) {
                console.error("Logo error", e);
              }

              // Title
              doc.setFont("helvetica", "bold");
              doc.setFontSize(16);
              doc.setTextColor("#FFFFFF");
              doc.text("SERVICIO TÉCNICO ESPECIALIZADO", 55, 18);

              doc.setFontSize(10);
              doc.setFont("helvetica", "normal");
              doc.text("SEGURIDAD 24/7 ECUADOR - INFORME TÉCNICO", 55, 26);

              let y = 55;

              // --- SECTION: CLIENT INFO (Boxed) ---
              doc.setFillColor(lightBG);
              doc.roundedRect(margin, y, contentWidth, 35, 3, 3, "F");
              doc.setDrawColor(primaryColor);
              doc.setLineWidth(0.5);
              doc.line(margin + 5, y + 10, margin + 60, y + 10);

              doc.setFont("helvetica", "bold");
              doc.setFontSize(12);
              doc.setTextColor(primaryColor);
              doc.text("DATOS DE LA ORDEN", margin + 5, y + 7);

              doc.setFontSize(10);
              doc.setTextColor(secondaryColor);
              doc.setFont("helvetica", "bold");
              doc.text("CLIENTE:", margin + 5, y + 20);
              doc.setFont("helvetica", "normal");
              doc.text(
                document.getElementById("reportClientName").innerText,
                margin + 45,
                y + 20
              );

              doc.setFont("helvetica", "bold");
              doc.text("FECHA ASIGNACIÓN:", margin + 5, y + 28);
              doc.setFont("helvetica", "normal");
              doc.text(
                document.getElementById("reportJobDate").innerText,
                margin + 45,
                y + 28
              );

              y += 45;

              // --- SECTION: STATUS ---
              doc.setFont("helvetica", "bold");
              doc.setFontSize(12);
              doc.setTextColor(primaryColor);
              doc.text("ESTADO DE FINALIZACIÓN", margin, y);
              doc.setDrawColor("#e0e0e0");
              doc.line(margin, y + 2, margin + contentWidth, y + 2);
              y += 10;

              doc.setFontSize(10);
              doc.setTextColor(secondaryColor);
              doc.text("ESTADO ACTUAL:", margin, y);
              const status = document.getElementById("reportStatus").innerText;
              doc.setTextColor(
                status === "Culminado" ? "#28a745" : primaryColor
              );
              doc.text(status.toUpperCase(), margin + 40, y);

              doc.setTextColor(secondaryColor);
              y += 7;
              doc.setFont("helvetica", "bold");
              doc.text("FECHA CIERRE:", margin, y);
              doc.setFont("helvetica", "normal");
              doc.text(
                `${document.getElementById("reportDate").innerText} - ${
                  document.getElementById("reportTime").innerText
                }`,
                margin + 40,
                y
              );

              y += 15;

              // --- SECTION: REPORT TEXT ---
              doc.setFont("helvetica", "bold");
              doc.setFontSize(12);
              doc.setTextColor(primaryColor);
              doc.text("DETALLE DEL TRABAJO REALIZADO", margin, y);
              doc.line(margin, y + 2, margin + contentWidth, y + 2);
              y += 10;

              doc.setFont("helvetica", "normal");
              doc.setFontSize(10);
              doc.setTextColor("#444444");
              const reportLines = doc.splitTextToSize(
                document.getElementById("reportText").innerText,
                contentWidth
              );
              doc.text(reportLines, margin, y);
              y += reportLines.length * 5 + 20;

              // --- SECTION: IMAGES ---
              if (y > 200) {
                doc.addPage();
                y = margin + 10;
              }

              doc.setFont("helvetica", "bold");
              doc.setFontSize(12);
              doc.setTextColor(primaryColor);
              doc.text("EVIDENCIA FOTOGRÁFICA", margin, y);
              doc.line(margin, y + 2, margin + contentWidth, y + 2);
              y += 10;

              const img1 = document.getElementById("reportImage1");
              const img2 = document.getElementById("reportImage2");

              const imgWidth = (contentWidth - 10) / 2;
              const imgHeight = 60;

              if (img1.src && img1.src.startsWith("data:")) {
                doc.setDrawColor("#ddd");
                doc.rect(margin - 1, y - 1, imgWidth + 2, imgHeight + 2);
                doc.addImage(img1.src, "JPEG", margin, y, imgWidth, imgHeight);
              }
              if (img2.src && img2.src.startsWith("data:")) {
                doc.setDrawColor("#ddd");
                doc.rect(
                  margin + imgWidth + 9,
                  y - 1,
                  imgWidth + 2,
                  imgHeight + 2
                );
                doc.addImage(
                  img2.src,
                  "JPEG",
                  margin + imgWidth + 10,
                  y,
                  imgWidth,
                  imgHeight
                );
              }

              y += imgHeight + 30;

              // --- SIGNATURES SECTION ---
              if (y > 230) {
                doc.addPage();
                y = 30;
              }

              const sigWidth = 50;
              const sigHeight = 30;

              // Technical Support Seal
              try {
                doc.addImage(seal, "PNG", margin + 15, y, sigWidth, sigHeight);
                doc.setDrawColor(primaryColor);
                doc.line(
                  margin + 5,
                  y + sigHeight + 2,
                  margin + sigWidth + 25,
                  y + sigHeight + 2
                );
                doc.setFont("helvetica", "bold");
                doc.setFontSize(9);
                doc.setTextColor(secondaryColor);
                doc.text(
                  "SELLO DE SOPORTE TÉCNICO",
                  margin + 12,
                  y + sigHeight + 7
                );
              } catch (e) {
                console.warn("Seal image not available");
              }

              // Client Signature
              const clientSigBase64 = document.getElementById(
                "reportClientSignature"
              ).src;
              if (clientSigBase64 && clientSigBase64.startsWith("data:")) {
                try {
                  doc.addImage(
                    clientSigBase64,
                    "PNG",
                    pageWidth - margin - sigWidth - 15,
                    y,
                    sigWidth,
                    sigHeight
                  );
                  doc.setDrawColor(primaryColor);
                  doc.line(
                    pageWidth - margin - sigWidth - 25,
                    y + sigHeight + 2,
                    pageWidth - margin - 5,
                    y + sigHeight + 2
                  );
                  doc.setFontSize(9);
                  doc.text(
                    "FIRMA DE CONFORMIDAD CLIENTE",
                    pageWidth - margin - sigWidth - 22,
                    y + sigHeight + 7
                  );
                } catch (e) {
                  console.warn("Client signature error", e);
                }
              }

              y += 50;

              // --- FOOTER ---
              doc.setFillColor(primaryColor);
              doc.rect(0, pageHeight - 15, pageWidth, 15, "F");
              doc.setFontSize(8);
              doc.setTextColor("#FFFFFF");
              doc.text(
                "© 2025 SEGURIDAD 24/7 ECUADOR & MCV (MALLITAXI CODE VISION). DOCUMENTO OFICIAL DE SERVICIO.",
                pageWidth / 2,
                pageHeight - 6,
                { align: "center" }
              );

              doc.save(
                `INFORME_${document
                  .getElementById("reportClientName")
                  .innerText.toUpperCase()
                  .replace(/\s+/g, "_")}.pdf`
              );
            }
          });

        // Filtros de trabajos
        document
          .getElementById("jobUrgencyFilter")
          .addEventListener("change", (e) => {
            const val = e.target.value;
            const search = document
              .getElementById("jobSearchInput")
              .value.toLowerCase();
            const filtered = window.allTrabajos.filter(
              (j) =>
                (val === "todas" || j.jobUrgency === val) &&
                j.clientName.toLowerCase().includes(search)
            );
            renderTrabajos(filtered);
          });

        document
          .getElementById("jobSearchInput")
          .addEventListener("input", (e) => {
            const val = e.target.value.toLowerCase();
            const urgency = document.getElementById("jobUrgencyFilter").value;
            const filtered = window.allTrabajos.filter(
              (j) =>
                (urgency === "todas" || j.jobUrgency === urgency) &&
                j.clientName.toLowerCase().includes(val)
            );
            renderTrabajos(filtered);
          });

        const passwordSearchInput = document.getElementById(
          "passwordSearchInput"
        );
        if (passwordSearchInput) {
          passwordSearchInput.addEventListener("input", (e) => {
            const val = e.target.value.toLowerCase();
            const filtered = window.allPasswords.filter(
              (p) =>
                p.complexName.toLowerCase().includes(val) ||
                (p.wifiName && p.wifiName.toLowerCase().includes(val))
            );
            renderClavesTecnicas(filtered);
          });
        }

        const handleLogout = () => {
          Swal.fire({
            title: "¿Cerrar Sesión?",
            text: "Estás por salir.",
            icon: "question",
            showCancelButton: true,
            confirmButtonColor: "#ff4444",
          }).then((result) => {
            if (result.isConfirmed)
              auth
                .signOut()
                .then(() => (window.location.href = "control_center.html"));
          });
        };

        const logoutBtn = document.getElementById("logoutBtn");
        const logoutBtnMobile = document.getElementById("logoutBtnMobile");
        if (logoutBtn) logoutBtn.addEventListener("click", handleLogout);
        if (logoutBtnMobile)
          logoutBtnMobile.addEventListener("click", handleLogout);

        const sidebarToggle = document.getElementById("sidebarToggle");
        const sidebar = document.getElementById("sidebar");
        if (sidebarToggle) {
          sidebarToggle.addEventListener("click", () => {
            sidebar.classList.toggle("show");
          });
        }

        // Cerrar sidebar al hacer clic en un link (móvil)
        document.querySelectorAll(".sidebar-link").forEach((link) => {
          link.addEventListener("click", () => {
            if (window.innerWidth < 992) {
              sidebar.classList.remove("show");
            }
          });
        });
      });
    </script>
  </body>
</html>
