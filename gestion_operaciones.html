<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Departamento de Operaciones - Seguridad 24/7</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/gestion_operaciones.css" />
    <link rel="stylesheet" href="css/index.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    />
    <!-- Select2 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link rel="icon" href="assets/img/logo.ico" type="image/x-icon" />
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  </head>

  <body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
      <div class="container">
        <a class="navbar-brand" href="#"
          >SEGURIDAD 24/7 <span class="d-none d-sm-inline">ECUADOR</span></a
        >

        <button class="navbar-toggler" type="button" id="sidebarToggle">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div
          class="collapse navbar-collapse d-none d-lg-flex justify-content-end"
          id="navbarNav"
        >
          <button class="btn-logout-nav" id="logoutBtn">
            <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión
          </button>
        </div>
      </div>
    </nav>

    <div class="admin-wrapper">
      <!-- SIDEBAR -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
          <img src="assets/img/logo.png" alt="Logo" />
          <span class="admin-label">OPERACIONES</span>
        </div>

        <ul class="sidebar-menu">
          <li class="sidebar-item">
            <a class="sidebar-link active" data-view="dashboard">
              <i class="fa-solid fa-gauge-high"></i> Dashboard
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" data-view="complexes">
              <i class="fa-solid fa-building-shield"></i> Conjuntos
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" data-view="passwords">
              <i class="fa-solid fa-key"></i> Gestión de Claves
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" data-view="jobs">
              <i class="fa-solid fa-briefcase"></i> Trabajos
            </a>
          </li>
          <!-- Logout for mobile -->
          <li class="sidebar-item d-lg-none mt-4">
            <button class="btn-logout-nav w-100" id="logoutBtnMobile">
              <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión
            </button>
          </li>
        </ul>
      </aside>

      <!-- CONTENT -->
      <main class="main-content">
        <div class="container-fluid">
          <!-- Dashboard Section -->
          <div id="dashboardSection">
            <h1 class="mb-5">Panel de Control de Operaciones</h1>

            <!-- Welcome Profile Card -->
            <div class="row mb-5">
              <div class="col-12">
                <div class="stat-card" id="userProfileCard">
                  <div class="d-flex align-items-center gap-4">
                    <div
                      class="stat-card-icon"
                      style="
                        background: rgba(212, 175, 55, 0.1);
                        color: #d4af37;
                      "
                    >
                      <i class="fa-solid fa-user-gear fa-lg"></i>
                    </div>
                    <div>
                      <h4 id="userName" class="text-gold mb-0">Cargando...</h4>
                      <p id="userEmail" class="text-white-50 mb-0"></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-4 mb-5">
              <div class="col-xl-4 col-md-6">
                <div class="stat-card">
                  <div
                    class="stat-card-icon"
                    style="background: rgba(212, 175, 55, 0.1); color: #d4af37"
                  >
                    <i class="fa-solid fa-building"></i>
                  </div>
                  <div class="stat-card-info">
                    <h3 id="statTotalComplexes">0</h3>
                    <p>Conjuntos Registrados</p>
                  </div>
                </div>
              </div>
              <div class="col-xl-4 col-md-6">
                <div class="stat-card">
                  <div
                    class="stat-card-icon"
                    style="background: rgba(40, 167, 69, 0.1); color: #28a745"
                  >
                    <i class="fa-solid fa-user-check"></i>
                  </div>
                  <div class="stat-card-info">
                    <h3 id="statTotalAdmins">0</h3>
                    <p>Administradores de Conjunto</p>
                  </div>
                </div>
              </div>
              <div class="col-xl-4 col-md-6">
                <div class="stat-card">
                  <div
                    class="stat-card-icon"
                    style="background: rgba(52, 152, 219, 0.1); color: #3498db"
                  >
                    <i class="fa-solid fa-briefcase"></i>
                  </div>
                  <div class="stat-card-info">
                    <h3 id="statTotalJobs">0</h3>
                    <p>Trabajos Técnicos</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Complexes Section -->
          <div id="complexesSection" style="display: none">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2 class="text-gold">Listado de Conjuntos</h2>
              <button
                class="btn btn-gold"
                data-bs-toggle="modal"
                data-bs-target="#addComplexModal"
              >
                <i class="fa-solid fa-plus me-2"></i> Nuevo Conjunto
              </button>
            </div>

            <div class="row g-4" id="complexesGrid">
              <!-- Se cargará dinámicamente -->
              <div class="col-12 text-center py-5 text-muted">
                <i class="fa-solid fa-spinner fa-spin fa-2x mb-2"></i
                ><br />Cargando conjuntos...
              </div>
            </div>
          </div>

          <!-- Passwords Section (Read-Only) -->
          <div id="passwordsSection" style="display: none">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2 class="text-gold mb-0">Gestión de Claves Técnicas</h2>
              <!-- Sin botón de agregar (Sólo lectura) -->
            </div>

            <div class="mb-4">
              <input
                type="text"
                id="passwordSearchInput"
                class="form-control"
                placeholder="Buscar por conjunto o dispositivo..."
              />
            </div>

            <div
              id="passwordsContainer"
              class="row g-4"
              style="margin-top: 20px"
            >
              <p class="text-center text-muted">Cargando claves...</p>
            </div>
          </div>

          <!-- Jobs Section -->
          <div id="jobsSection" style="display: none">
            <div class="d-flex justify-content-between align-items-center mb-5">
              <h2 class="text-gold mb-0">Gestión de Trabajos</h2>
              <div class="d-flex gap-3 align-items-center">
                <select id="jobUrgencyFilter" class="modern-select">
                  <option value="todas">Urgencia: Todas</option>
                  <option value="Normal">Normal</option>
                  <option value="Urgente">Urgente</option>
                  <option value="Crítico">Crítico</option>
                </select>
                <input
                  type="text"
                  id="jobSearchInput"
                  class="modern-input"
                  placeholder="Buscar cliente..."
                />
                <button
                  class="btn btn-gold px-4"
                  data-bs-toggle="modal"
                  data-bs-target="#addJobModal"
                >
                  <i class="fa-solid fa-plus me-2"></i> Crear Trabajo
                </button>
              </div>
            </div>

            <div id="jobsContainer" class="row g-4">
              <p class="text-center text-muted">Cargando trabajos...</p>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- MODAL AGREGAR CONJUNTO -->
    <div
      class="modal fade"
      id="addComplexModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Registrar Conjunto</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body p-4">
            <form id="addComplexForm">
              <div class="mb-3">
                <div
                  class="d-flex justify-content-between align-items-center mb-1"
                >
                  <label class="form-label mb-0"
                    >REPRESENTANTE / ADMINISTRADOR</label
                  >
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="toggleAdminManual"
                      style="cursor: pointer"
                    />
                    <label
                      class="form-check-label small text-white-50"
                      for="toggleAdminManual"
                      style="cursor: pointer; font-size: 0.7rem"
                    >
                      No registrado aún
                    </label>
                  </div>
                </div>

                <div id="adminLinkWrapper">
                  <select id="complexAdmin" class="form-select select2-admin">
                    <option value="" disabled selected>
                      Seleccione un administrador...
                    </option>
                  </select>
                </div>

                <div id="adminManualWrapper" style="display: none">
                  <input
                    type="text"
                    id="complexAdminManual"
                    class="form-control force-uppercase"
                    placeholder="Escriba el nombre del administrador"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">NOMBRE DEL CONJUNTO</label>
                <input
                  type="text"
                  id="complexName"
                  class="form-control force-uppercase"
                  placeholder="Ej: Urbanización Los Pinos"
                  required
                />
              </div>
              <div class="d-grid mt-4">
                <button type="submit" class="btn btn-gold">
                  <i class="fa-solid fa-save me-2"></i> GUARDAR CONJUNTO
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL VER REGISTROS -->
    <div
      class="modal fade"
      id="viewRegistriesModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div
        class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable"
      >
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title d-flex align-items-center flex-wrap">
              <i class="fa-solid fa-clipboard-list me-2"></i>
              <span>Registros de&nbsp;</span>
              <span id="registriesComplexName" class="fw-bold"></span>
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body p-4">
            <div id="registriesTableContainer">
              <div class="text-center py-5">
                <i class="fa-solid fa-spinner fa-spin fa-2x text-gold mb-3"></i>
                <p class="text-muted">Cargando registros...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL EDITAR REGISTRO -->
    <div
      class="modal fade"
      id="editRegistryModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fa-solid fa-pen-to-square text-white me-2"></i>
              Editar Registro de Residente
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body p-4">
            <form id="editRegistryForm">
              <input type="hidden" id="editRegId" />
              <input type="hidden" id="editRegComplexName" />

              <div class="row g-3 mb-4">
                <div class="col-md-7">
                  <label class="form-label">CASA / DEPARTAMENTO #</label>
                  <input
                    type="text"
                    id="editRegHouseNum"
                    class="form-control force-uppercase"
                    placeholder="Ej: Villa 05"
                    required
                  />
                </div>
                <div class="col-md-5">
                  <label class="form-label">TIPO</label>
                  <select id="editRegResType" class="form-select" required>
                    <option value="propietario">Propietario</option>
                    <option value="arrendatario">Arrendatario</option>
                  </select>
                </div>
              </div>

              <div class="mb-4">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <h6 class="text-gold mb-0 fw-bold">
                    <i class="fa-solid fa-users me-2"></i> Residentes
                  </h6>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-gold"
                    onclick="addResidentEntryEdit()"
                  >
                    <i class="fa-solid fa-plus me-1"></i> Añadir
                  </button>
                </div>
                <div
                  id="editResidentsContainer"
                  class="d-flex flex-column gap-3"
                ></div>
              </div>

              <div class="mb-4">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <h6 class="text-gold mb-0 fw-bold">
                    <i class="fa-solid fa-car me-2"></i> Vehículos
                  </h6>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-gold"
                    onclick="addVehicleEntryEdit()"
                  >
                    <i class="fa-solid fa-plus me-1"></i> Añadir
                  </button>
                </div>
                <div
                  id="editVehiclesContainer"
                  class="d-flex flex-column gap-3"
                ></div>
              </div>

              <div class="d-grid mt-4">
                <button type="submit" class="btn btn-gold">
                  <i class="fa-solid fa-save me-2"></i> ACTUALIZAR REGISTRO
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL AGREGAR TRABAJO -->
    <div class="modal fade" id="addJobModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark border-gold shadow-lg">
          <div class="modal-header border-bottom border-secondary">
            <h5 class="modal-title text-gold">
              <i class="fa-solid fa-briefcase me-2"></i> AGREGAR TRABAJO
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body p-4">
            <form id="addJobForm">
              <div class="row g-3">
                <!-- Columna Izquierda -->
                <div class="col-md-6 mb-3">
                  <label
                    class="form-label text-gold fw-bold text-uppercase small"
                    >Cliente (Conjunto)</label
                  >
                  <input
                    type="text"
                    id="clientName"
                    class="form-control force-uppercase bg-secondary text-white border-0"
                    placeholder="Ej: Urbanización Los Pinos"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label
                    class="form-label text-gold fw-bold text-uppercase small"
                    >Fecha de Publicación</label
                  >
                  <input
                    type="date"
                    class="form-control bg-secondary text-white border-0"
                    id="jobDate"
                    required
                  />
                </div>

                <div class="col-md-6 mb-3">
                  <label
                    class="form-label text-gold fw-bold text-uppercase small"
                    >Urgencia</label
                  >
                  <select
                    class="form-select bg-secondary text-white border-0"
                    id="jobUrgency"
                    required
                  >
                    <option value="Normal">Normal</option>
                    <option value="Urgente">Urgente</option>
                    <option value="Crítico">Crítico</option>
                  </select>
                </div>

                <div class="col-md-6 mb-3">
                  <!-- Spacer or another field could go here, but for now we keep flow -->
                  <label
                    class="form-label text-gold fw-bold text-uppercase small"
                    >Nombre de Contacto</label
                  >
                  <input
                    type="text"
                    class="form-control force-uppercase bg-secondary text-white border-0"
                    id="contactName"
                    required
                  />
                </div>

                <div class="col-md-6 mb-3">
                  <label
                    class="form-label text-gold fw-bold text-uppercase small"
                    >Teléfono de Contacto</label
                  >
                  <input
                    type="text"
                    class="form-control bg-secondary text-white border-0"
                    id="contactPhone"
                    required
                  />
                </div>

                <div class="col-md-6 mb-3">
                  <label
                    class="form-label text-gold fw-bold text-uppercase small"
                    >Imagen del Problema</label
                  >
                  <input
                    class="form-control bg-secondary text-white border-0"
                    type="file"
                    id="jobImage"
                    accept="image/*"
                  />
                </div>

                <div class="col-12 mb-3">
                  <label
                    class="form-label text-gold fw-bold text-uppercase small"
                    >Descripción del Problema</label
                  >
                  <textarea
                    class="form-control bg-secondary text-white border-0"
                    id="jobDescription"
                    rows="4"
                    placeholder="Detalle el problema técnico aquí..."
                    required
                  ></textarea>
                </div>
              </div>

              <div class="d-grid mt-4">
                <button
                  type="submit"
                  class="btn btn-gold py-2 fw-bold shadow-sm"
                >
                  <i class="fa-solid fa-save me-2"></i> GUARDAR TRABAJO
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL EDITAR TRABAJO -->
    <div class="modal fade" id="editJobModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar Trabajo</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body p-4">
            <form id="editJobForm">
              <input type="hidden" id="editJobId" />
              <div class="mb-3">
                <label class="form-label">Nombre del Cliente (Conjunto)</label>
                <input
                  type="text"
                  id="editClientName"
                  class="form-control force-uppercase"
                  placeholder="Ej: Urbanización Los Pinos"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Fecha de Publicación</label>
                <input
                  type="date"
                  class="form-control"
                  id="editJobDate"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Estado de Urgencia</label>
                <select class="form-select" id="editJobUrgency" required>
                  <option value="Normal">Normal</option>
                  <option value="Urgente">Urgente</option>
                  <option value="Crítico">Crítico</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Nombre de Contacto</label>
                <input
                  type="text"
                  class="form-control force-uppercase"
                  id="editContactName"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Número de Contacto</label>
                <input
                  type="text"
                  class="form-control"
                  id="editContactPhone"
                  required
                />
              </div>
              <div class="d-grid mt-4">
                <button type="submit" class="btn btn-gold">
                  <i class="fa-solid fa-save me-2"></i> ACTUALIZAR TRABAJO
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL VER REPORTE -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
      <div
        class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable"
      >
        <div
          class="modal-content"
          style="
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            border: 2px solid #d4af37;
            border-radius: 20px;
            overflow: hidden;
          "
        >
          <!-- HEADER PREMIUM -->
          <div
            style="
              background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
              padding: 20px 25px;
              position: relative;
              overflow: hidden;
            "
          >
            <div
              style="
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: repeating-linear-gradient(
                  45deg,
                  transparent,
                  transparent 10px,
                  rgba(255, 255, 255, 0.05) 10px,
                  rgba(255, 255, 255, 0.05) 20px
                );
                opacity: 0.3;
              "
            ></div>

            <div
              class="d-flex align-items-center justify-content-between position-relative"
            >
              <div class="d-flex align-items-center">
                <div
                  style="
                    width: 50px;
                    height: 50px;
                    background: rgba(0, 0, 0, 0.2);
                    border-radius: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-right: 15px;
                  "
                >
                  <i
                    class="fa-solid fa-file-lines"
                    style="color: #000; font-size: 1.5rem"
                  ></i>
                </div>
                <div>
                  <h5
                    class="mb-0 fw-bold"
                    style="
                      color: #000;
                      font-size: 1.3rem;
                      letter-spacing: 0.5px;
                    "
                  >
                    INFORME TÉCNICO
                  </h5>
                  <small style="color: rgba(0, 0, 0, 0.7); font-weight: 600"
                    >Reporte de Trabajo Completado</small
                  >
                </div>
              </div>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                style="
                  background-color: transparent;
                  border-radius: 8px;
                  padding: 10px;
                  opacity: 1;
                "
              ></button>
            </div>
          </div>

          <!-- BODY CON LAYOUT 2 COLUMNAS -->
          <div
            class="modal-body"
            style="padding: 20px; max-height: 70vh; overflow-y: auto"
          >
            <!-- INFO CARDS COMPACTAS -->
            <div class="row g-2 mb-3">
              <div class="col-6 col-md-3">
                <div
                  style="
                    background: rgba(212, 175, 55, 0.08);
                    border: 1px solid rgba(212, 175, 55, 0.2);
                    border-radius: 12px;
                    padding: 12px;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                  "
                >
                  <div class="d-flex align-items-center mb-2">
                    <div
                      style="
                        width: 32px;
                        height: 32px;
                        background: linear-gradient(135deg, #d4af37, #f4d03f);
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin-right: 8px;
                      "
                    >
                      <i
                        class="fa-solid fa-user"
                        style="color: #000; font-size: 0.9rem"
                      ></i>
                    </div>
                    <span
                      style="
                        color: #d4af37;
                        font-size: 0.7rem;
                        font-weight: 700;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                      "
                      >Cliente</span
                    >
                  </div>
                  <span
                    id="reportClientName"
                    style="
                      color: #fff;
                      font-weight: 600;
                      font-size: 0.85rem;
                      display: block;
                      line-height: 1.2;
                    "
                  ></span>
                </div>
              </div>

              <div class="col-6 col-md-3">
                <div
                  style="
                    background: rgba(212, 175, 55, 0.08);
                    border: 1px solid rgba(212, 175, 55, 0.2);
                    border-radius: 12px;
                    padding: 12px;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                  "
                >
                  <div class="d-flex align-items-center mb-2">
                    <div
                      style="
                        width: 32px;
                        height: 32px;
                        background: linear-gradient(135deg, #28a745, #20c997);
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin-right: 8px;
                      "
                    >
                      <i
                        class="fa-solid fa-check-circle"
                        style="color: #fff; font-size: 0.9rem"
                      ></i>
                    </div>
                    <span
                      style="
                        color: #d4af37;
                        font-size: 0.7rem;
                        font-weight: 700;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                      "
                      >Estado</span
                    >
                  </div>
                  <span
                    id="reportStatus"
                    style="font-weight: 700; font-size: 0.85rem; display: block"
                  ></span>
                </div>
              </div>

              <div class="col-6 col-md-3">
                <div
                  style="
                    background: rgba(212, 175, 55, 0.08);
                    border: 1px solid rgba(212, 175, 55, 0.2);
                    border-radius: 12px;
                    padding: 12px;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                  "
                >
                  <span
                    style="
                      color: #888;
                      font-size: 0.7rem;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                      display: block;
                      margin-bottom: 4px;
                    "
                    >Asignación</span
                  >
                  <span
                    id="reportJobDate"
                    style="
                      color: #fff;
                      font-weight: 600;
                      display: block;
                      font-size: 0.85rem;
                    "
                  ></span>
                </div>
              </div>

              <div class="col-6 col-md-3">
                <div
                  style="
                    background: rgba(212, 175, 55, 0.08);
                    border: 1px solid rgba(212, 175, 55, 0.2);
                    border-radius: 12px;
                    padding: 12px;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                  "
                >
                  <span
                    style="
                      color: #888;
                      font-size: 0.7rem;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                      display: block;
                      margin-bottom: 4px;
                    "
                    >Finalización</span
                  >
                  <span
                    style="
                      color: #fff;
                      font-weight: 600;
                      display: block;
                      font-size: 0.85rem;
                    "
                  >
                    <span id="reportDate"></span> <span id="reportTime"></span>
                  </span>
                </div>
              </div>
            </div>

            <!-- LAYOUT 2 COLUMNAS: PROBLEMA | TRABAJO -->
            <div class="row g-3 mb-3">
              <!-- COLUMNA IZQUIERDA: PROBLEMA REPORTADO -->
              <div class="col-lg-6">
                <div
                  id="initialProblemSection"
                  style="display: none; height: 100%"
                >
                  <div
                    style="
                      background: linear-gradient(
                        135deg,
                        rgba(255, 193, 7, 0.12),
                        rgba(255, 152, 0, 0.08)
                      );
                      border: 2px solid rgba(255, 193, 7, 0.3);
                      border-radius: 15px;
                      padding: 20px;
                      height: 100%;
                      display: flex;
                      flex-direction: column;
                    "
                  >
                    <div class="d-flex align-items-center mb-3">
                      <div
                        style="
                          width: 40px;
                          height: 40px;
                          background: rgba(255, 193, 7, 0.2);
                          border-radius: 10px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          margin-right: 12px;
                        "
                      >
                        <i
                          class="fa-solid fa-exclamation-triangle"
                          style="color: #ffc107; font-size: 1.2rem"
                        ></i>
                      </div>
                      <h6
                        class="mb-0 fw-bold"
                        style="
                          color: #ffc107;
                          font-size: 1rem;
                          letter-spacing: 0.5px;
                        "
                      >
                        PROBLEMA REPORTADO
                      </h6>
                    </div>

                    <div class="mb-3">
                      <strong
                        style="
                          color: #ffc107;
                          font-size: 0.85rem;
                          display: block;
                          margin-bottom: 8px;
                        "
                        >Descripción:</strong
                      >
                      <p
                        id="reportProblemDescription"
                        style="
                          color: #e0e0e0;
                          margin: 0;
                          line-height: 1.6;
                          font-size: 0.9rem;
                        "
                      ></p>
                    </div>

                    <div
                      id="reportProblemImageContainer"
                      class="mt-auto text-center"
                    >
                      <strong
                        style="
                          color: #ffc107;
                          font-size: 0.85rem;
                          display: block;
                          margin-bottom: 10px;
                        "
                        >Imagen del Problema:</strong
                      >
                      <div
                        style="
                          border: 2px solid rgba(255, 193, 7, 0.4);
                          border-radius: 12px;
                          overflow: hidden;
                          cursor: pointer;
                          box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2);
                          max-width: 50%;
                          margin: 0 auto;
                        "
                        onclick="
                          openImageFullscreen(
                            document.getElementById('reportProblemImage').src,
                          )
                        "
                      >
                        <img
                          id="reportProblemImage"
                          src=""
                          alt="Problema"
                          style="
                            width: 100%;
                            height: auto;
                            display: block;
                            transition: transform 0.3s;
                          "
                          onmouseover="this.style.transform = 'scale(1.05)'"
                          onmouseout="this.style.transform = 'scale(1)'"
                        />
                      </div>
                      <small
                        style="
                          color: #ffc107;
                          display: block;
                          margin-top: 8px;
                          font-size: 0.75rem;
                          text-align: center;
                        "
                      >
                        <i class="fa-solid fa-expand"></i> Click para ampliar
                      </small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- COLUMNA DERECHA: TRABAJO + EVIDENCIAS -->
              <div class="col-lg-6">
                <div
                  style="
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                    height: 100%;
                  "
                >
                  <!-- TRABAJO REALIZADO -->
                  <div
                    style="
                      background: linear-gradient(
                        135deg,
                        rgba(212, 175, 55, 0.08),
                        rgba(212, 175, 55, 0.03)
                      );
                      border: 2px solid rgba(212, 175, 55, 0.25);
                      border-radius: 15px;
                      padding: 20px;
                      flex: 1;
                    "
                  >
                    <div class="d-flex align-items-center mb-3">
                      <div
                        style="
                          width: 40px;
                          height: 40px;
                          background: rgba(212, 175, 55, 0.2);
                          border-radius: 10px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          margin-right: 12px;
                        "
                      >
                        <i
                          class="fa-solid fa-wrench"
                          style="color: #d4af37; font-size: 1.2rem"
                        ></i>
                      </div>
                      <h6
                        class="mb-0 fw-bold"
                        style="
                          color: #d4af37;
                          font-size: 1rem;
                          letter-spacing: 0.5px;
                        "
                      >
                        TRABAJO REALIZADO
                      </h6>
                    </div>
                    <div
                      id="reportText"
                      style="
                        color: #e0e0e0;
                        line-height: 1.7;
                        font-size: 0.9rem;
                        white-space: pre-wrap;
                      "
                    ></div>
                  </div>

                  <!-- EVIDENCIAS FOTOGRÁFICAS -->
                  <div
                    style="
                      background: linear-gradient(
                        135deg,
                        rgba(212, 175, 55, 0.08),
                        rgba(212, 175, 55, 0.03)
                      );
                      border: 2px solid rgba(212, 175, 55, 0.25);
                      border-radius: 15px;
                      padding: 20px;
                    "
                  >
                    <div class="d-flex align-items-center mb-3">
                      <div
                        style="
                          width: 40px;
                          height: 40px;
                          background: rgba(212, 175, 55, 0.2);
                          border-radius: 10px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          margin-right: 12px;
                        "
                      >
                        <i
                          class="fa-solid fa-camera"
                          style="color: #d4af37; font-size: 1.2rem"
                        ></i>
                      </div>
                      <h6
                        class="mb-0 fw-bold"
                        style="
                          color: #d4af37;
                          font-size: 1rem;
                          letter-spacing: 0.5px;
                        "
                      >
                        EVIDENCIAS
                      </h6>
                    </div>
                    <div class="row g-2">
                      <div class="col-6">
                        <div
                          style="
                            border: 2px solid rgba(212, 175, 55, 0.3);
                            border-radius: 10px;
                            overflow: hidden;
                            aspect-ratio: 4/3;
                            background: #000;
                            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
                          "
                        >
                          <img
                            id="reportImage1"
                            src=""
                            alt="Evidencia 1"
                            style="width: 100%; height: 100%; object-fit: cover"
                          />
                        </div>
                      </div>
                      <div class="col-6">
                        <div
                          style="
                            border: 2px solid rgba(212, 175, 55, 0.3);
                            border-radius: 10px;
                            overflow: hidden;
                            aspect-ratio: 4/3;
                            background: #000;
                            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
                          "
                        >
                          <img
                            id="reportImage2"
                            src=""
                            alt="Evidencia 2"
                            style="width: 100%; height: 100%; object-fit: cover"
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- FIRMAS (ANCHO COMPLETO) -->
            <div id="reportSignaturesSection" style="display: none">
              <div
                style="
                  background: linear-gradient(
                    135deg,
                    rgba(212, 175, 55, 0.08),
                    rgba(212, 175, 55, 0.03)
                  );
                  border: 2px solid rgba(212, 175, 55, 0.25);
                  border-radius: 15px;
                  padding: 20px;
                "
              >
                <div class="d-flex align-items-center mb-3">
                  <div
                    style="
                      width: 40px;
                      height: 40px;
                      background: rgba(212, 175, 55, 0.2);
                      border-radius: 10px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      margin-right: 12px;
                    "
                  >
                    <i
                      class="fa-solid fa-signature"
                      style="color: #d4af37; font-size: 1.2rem"
                    ></i>
                  </div>
                  <h6
                    class="mb-0 fw-bold"
                    style="
                      color: #d4af37;
                      font-size: 1rem;
                      letter-spacing: 0.5px;
                    "
                  >
                    FIRMAS DE CONFORMIDAD
                  </h6>
                </div>
                <div class="row g-4 justify-content-center">
                  <div class="col-md-6 d-flex justify-content-center">
                    <div
                      style="
                        background: rgba(0, 0, 0, 0.2);
                        border: 2px solid rgba(212, 175, 55, 0.3);
                        border-radius: 16px;
                        padding: 25px;
                        width: 100%;
                        max-width: 350px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: space-between;
                        box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
                      "
                    >
                      <small
                        class="d-block mb-3 fw-bold"
                        style="
                          color: #d4af37;
                          font-size: 0.9rem;
                          text-transform: uppercase;
                          letter-spacing: 1.5px;
                          text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
                        "
                        >Sello Técnico</small
                      >
                      <div
                        style="
                          background: rgba(255, 255, 255, 0.03);
                          border-radius: 12px;
                          padding: 15px;
                          width: 100%;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          min-height: 160px;
                          border: 1px dashed rgba(212, 175, 55, 0.3);
                        "
                      >
                        <img
                          src="assets/img/sello.png"
                          alt="Sello"
                          style="
                            max-height: 120px;
                            max-width: 100%;
                            width: auto;
                            object-fit: contain;
                            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
                            transition: transform 0.3s;
                          "
                          onmouseover="this.style.transform = 'scale(1.05)'"
                          onmouseout="this.style.transform = 'scale(1)'"
                        />
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 d-flex justify-content-center">
                    <div
                      style="
                        background: rgba(0, 0, 0, 0.2);
                        border: 2px solid rgba(212, 175, 55, 0.3);
                        border-radius: 16px;
                        padding: 25px;
                        width: 100%;
                        max-width: 350px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: space-between;
                        box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
                      "
                    >
                      <small
                        class="d-block mb-3 fw-bold"
                        style="
                          color: #d4af37;
                          font-size: 0.9rem;
                          text-transform: uppercase;
                          letter-spacing: 1.5px;
                          text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
                        "
                        >Firma del Cliente</small
                      >
                      <div
                        style="
                          background: rgba(255, 255, 255, 0.03);
                          border-radius: 12px;
                          padding: 15px;
                          width: 100%;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          min-height: 160px;
                          border: 1px dashed rgba(212, 175, 55, 0.3);
                        "
                      >
                        <img
                          id="reportClientSignature"
                          src=""
                          alt="Firma"
                          style="
                            max-height: 120px;
                            max-width: 100%;
                            width: auto;
                            object-fit: contain;
                            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
                            transition: transform 0.3s;
                          "
                          onmouseover="this.style.transform = 'scale(1.05)'"
                          onmouseout="this.style.transform = 'scale(1)'"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- FOOTER CON BOTÓN PDF -->
          <div
            style="
              background: linear-gradient(180deg, #0a0a0a 0%, #000 100%);
              border-top: 1px solid rgba(212, 175, 55, 0.3);
              padding: 15px 20px;
            "
          >
            <button
              type="button"
              id="generateJobPdfBtn"
              style="
                background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
                border: none;
                color: #000;
                padding: 14px 30px;
                border-radius: 12px;
                font-weight: 700;
                font-size: 1rem;
                letter-spacing: 1px;
                box-shadow: 0 4px 20px rgba(212, 175, 55, 0.5);
                transition: all 0.3s ease;
                cursor: pointer;
                width: 100%;
                text-transform: uppercase;
              "
              onmouseover="
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 6px 30px rgba(212, 175, 55, 0.7)';
              "
              onmouseout="
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 4px 20px rgba(212, 175, 55, 0.5)';
              "
            >
              <i class="fa-solid fa-file-pdf me-2"></i>
              GENERAR PDF
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- FOOTER -->
    <footer class="footer">
      © 2025 Seguridad 24/7 Ecuador &
      <a
        href="https://mallitaxicodevision.netlify.app/"
        target="_blank"
        rel="noopener noreferrer"
        class="footer-link"
      >
        MCV (Mallitaxi Code Vision)
      </a>
      — Todos los derechos reservados
    </footer>

    <!-- SCRIPTS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="js/firebase.js"></script>
    <script src="js/sweetalert2.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/pdf_generator_modern.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Auth check
        auth.onAuthStateChanged(async (user) => {
          if (!user) {
            window.location.href = "control_center.html";
            return;
          }

          const doc = await db.collection("users").doc(user.uid).get();
          const userData = doc.exists ? doc.data() : null;
          const role = userData ? userData.role : "";

          if (role !== "operaciones" && role !== "monitoreo") {
            window.location.href = "control_center.html";
            return;
          }

          document.getElementById("userName").textContent =
            userData.adminName || userData.nombre || "Operador";
          document.getElementById("userEmail").textContent = user.email;

          cargarEstadisticas();
          cargarConjuntos();
        });

        // Sidebar Navigation
        const sidebarLinks = document.querySelectorAll(".sidebar-link");
        const sections = [
          "dashboardSection",
          "complexesSection",
          "passwordsSection",
          "jobsSection",
        ];

        sidebarLinks.forEach((link) => {
          link.addEventListener("click", (e) => {
            const view = link.getAttribute("data-view");
            sidebarLinks.forEach((l) => l.classList.remove("active"));
            link.classList.add("active");

            sections.forEach((s) => {
              const el = document.getElementById(s);
              if (el) el.style.display = "none";
            });

            const target = document.getElementById(view + "Section");
            if (target) target.style.display = "block";

            // Si es la vista de claves, cargar datos
            if (view === "passwords") {
              if (!window.passwordsLoaded) cargarClavesTecnicas();
              else renderClavesTecnicas(window.allPasswords);
            }

            if (view === "jobs") {
              cargarTrabajos();
            }

            const sidebar = document.getElementById("sidebar");
            if (window.innerWidth <= 991) sidebar.classList.remove("show");
          });
        });

        // --- SELECT2 Y CARGA DE ADMINISTRADORES ---
        function formatAdminResult(admin) {
          if (!admin.id || !admin.element) return admin.text;
          const complex = $(admin.element).data("complex");
          return $(`
                <div class="p-1">
                    <div style="color: #d4af37; font-weight: 700; font-size: 0.95rem;">${
                      admin.text
                    }</div>
                    <div style="color: rgba(255,255,255,0.5); font-size: 0.75rem; margin-top: 2px;">
                        <i class="fa-solid fa-building me-1"></i> ${
                          complex || "Sin conjunto asignado"
                        }
                    </div>
                </div>
            `);
        }

        async function cargarOpcionesSelect2() {
          try {
            const snapshot = await db
              .collection("users")
              .where("role", "==", "ADMIN_CONJUNTO")
              .get();
            const select = $("#complexAdmin");
            select
              .empty()
              .append(
                '<option value="" disabled selected>Seleccione un administrador...</option>',
              );

            snapshot.forEach((doc) => {
              const data = doc.data();
              const name = data.adminName || data.name || "Sin nombre";
              const complex = data.complexName || "No asignado";
              const option = new Option(name, name, false, false);
              $(option).attr("data-complex", complex);
              select.append(option);
            });

            $(".select2-admin")
              .select2({
                dropdownParent: $("#addComplexModal"),
                width: "100%",
                templateResult: formatAdminResult,
                templateSelection: (state) => state.text,
              })
              .on("select2:select", function (e) {
                const data = e.params.data;
                const complexName = $(data.element).data("complex");
                if (complexName && complexName !== "No asignado") {
                  $("#complexName").val(complexName);
                }
              });

            // Lógica para toggle de administrador manual
            document
              .getElementById("toggleAdminManual")
              .addEventListener("change", function (e) {
                const manualWrapper =
                  document.getElementById("adminManualWrapper");
                const linkWrapper = document.getElementById("adminLinkWrapper");
                const manualInput =
                  document.getElementById("complexAdminManual");

                if (e.target.checked) {
                  manualWrapper.style.display = "block";
                  linkWrapper.style.display = "none";
                  manualInput.setAttribute("required", "required");
                } else {
                  manualWrapper.style.display = "none";
                  linkWrapper.style.display = "block";
                  manualInput.removeAttribute("required");
                }
              });
          } catch (error) {
            console.error("Error cargando admins para Select2:", error);
          }
        }

        // CARGAR CONJUNTOS PARA SELECTS DE TRABAJOS
        async function cargarConjuntosParaSelects(targetValue = null) {
          try {
            const snapshot = await db
              .collection("complexes")
              .orderBy("name", "asc")
              .get();
            const selects = $(".select2-complex");

            selects.each(function () {
              const $el = $(this);
              const currentVal = $el.val();
              $el
                .empty()
                .append(
                  '<option value="" disabled selected>Seleccione un conjunto...</option>',
                );

              snapshot.forEach((doc) => {
                const data = doc.data();
                $el.append(new Option(data.name, data.name));
              });

              if (targetValue) {
                $el.val(targetValue).trigger("change");
              } else if (currentVal) {
                $el.val(currentVal).trigger("change");
              }
            });

            // Inicializar Select2 si no está inicializado
            $(".select2-complex").select2({
              width: "100%",
              dropdownParent: function (el) {
                return $(el).closest(".modal");
              },
            });
          } catch (error) {
            console.error("Error cargando conjuntos para selects:", error);
          }
        }

        cargarOpcionesSelect2();
        cargarConjuntosParaSelects();

        async function cargarEstadisticas() {
          const complexesSnap = await db.collection("complexes").get();
          document.getElementById("statTotalComplexes").textContent =
            complexesSnap.size;

          const adminsSnap = await db
            .collection("users")
            .where("role", "==", "ADMIN_CONJUNTO")
            .get();
          document.getElementById("statTotalAdmins").textContent =
            adminsSnap.size;

          const jobsSnap = await db.collection("trabajos").get();
          const realJobsCount = jobsSnap.docs.filter(
            (doc) => !doc.data().isGuide,
          ).length;
          document.getElementById("statTotalJobs").textContent = realJobsCount;
        }

        async function cargarConjuntos() {
          const container = document.getElementById("complexesGrid");
          if (!container) return;
          try {
            const snapshot = await db
              .collection("complexes")
              .orderBy("createdAt", "desc")
              .get();
            container.innerHTML = "";
            if (snapshot.empty) {
              container.innerHTML =
                '<div class="col-12 text-center py-5 text-white-50">No hay conjuntos registrados aún.</div>';
              return;
            }
            snapshot.forEach((doc) => {
              const data = doc.data();
              const card = `
                        <div class="col-xl-3 col-lg-4 col-md-6">
                            <div class="stat-card" style="display: block; height: auto; padding: 20px; border-radius: 15px;">
                                <div class="text-center mb-3">
                                    <div style="width: 50px; height: 50px; background: rgba(212,175,55,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; border: 1px solid rgba(212,175,55,0.3);">
                                        <i class="fa-solid fa-building" style="font-size: 1.3rem; color: #d4af37;"></i>
                                    </div>
                                </div>
                                <h5 class="text-gold mb-2 text-center text-truncate" style="font-size: 1rem; font-weight: 700;">${data.name}</h5>
                                <div class="text-center mb-3" style="padding: 8px; background: rgba(255,255,255,0.02); border-radius: 8px;">
                                    <i class="fa-solid fa-user-shield text-gold me-1" style="font-size: 0.75rem;"></i>
                                    <span class="small text-white-50" style="font-size: 0.75rem;">${data.admin}</span>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-gold w-100 py-2" onclick="verRegistros('${data.name}')" style="font-size: 0.75rem; border-radius: 8px;">
                                        <i class="fa-solid fa-clipboard-list me-1"></i> Registros
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="eliminarConjunto('${doc.id}')" title="Eliminar" style="width: 45px; border-radius: 8px;">
                                        <i class="fa-solid fa-trash" style="font-size: 0.8rem;"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
              container.innerHTML += card;
            });
          } catch (error) {
            console.error("Error al cargar conjuntos:", error);
            container.innerHTML =
              '<div class="col-12 text-center py-5 text-danger">Error al cargar la lista.</div>';
          }
        }

        // Nueva función para ver registros
        window.verRegistros = async (complexName) => {
          document.getElementById("registriesComplexName").textContent =
            complexName;
          const modal = new bootstrap.Modal(
            document.getElementById("viewRegistriesModal"),
          );
          modal.show();

          const container = document.getElementById("registriesTableContainer");

          try {
            const snapshot = await db
              .collection("residents_registry")
              .where("complexName", "==", complexName)
              .get();

            if (snapshot.empty) {
              container.innerHTML = `
                <div class="text-center py-5">
                  <i class="fa-solid fa-inbox fa-3x text-muted mb-3"></i>
                  <p class="text-muted">No hay registros para este conjunto aún.</p>
                </div>
              `;
              return;
            }

            // Convertir a array y ordenar por fecha (más reciente primero)
            const registros = [];
            snapshot.forEach((doc) => {
              registros.push({ id: doc.id, ...doc.data() });
            });
            registros.sort((a, b) => {
              const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
              const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
              return dateB - dateA;
            });

            let tableHTML = `
              <div class="table-responsive">
                <table class="table table-dark-premium table-hover align-middle">
                  <thead>
                    <tr>
                      <th class="text-center">Vivienda</th>
                      <th class="text-center">Tipo</th>
                      <th class="text-center">Residente(s)</th>
                      <th class="text-center">Teléfono/WhatsApp</th>
                      <th class="text-center">Marca</th>
                      <th class="text-center">Modelo</th>
                      <th class="text-center">Color</th>
                      <th class="text-center">Placa</th>
                      <th class="text-center">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
            `;

            registros.forEach((data) => {
              const maxRows = Math.max(
                data.residents ? data.residents.length : 0,
                data.vehicles ? data.vehicles.length : 0,
                1,
              );

              // Flag to handle cases with 1 vehicle but multiple residents (rowspan)
              const singleVehicleMultipleResidents =
                data.vehicles &&
                data.vehicles.length === 1 &&
                data.residents &&
                data.residents.length > 1;

              for (let i = 0; i < maxRows; i++) {
                const resident =
                  data.residents && data.residents[i]
                    ? data.residents[i]
                    : null;
                const vehicle =
                  data.vehicles && data.vehicles[i] ? data.vehicles[i] : null;

                tableHTML += `<tr>`;

                if (i === 0) {
                  tableHTML += `
                          <td class="text-center fw-bold text-gold" rowspan="${maxRows}">${
                            data.houseNum
                          }</td>
                          <td class="text-center align-middle" rowspan="${maxRows}">
                            <span class="badge ${
                              data.resType === "PROPIETARIO"
                                ? "bg-gold text-dark"
                                : "bg-outline-gold"
                            }">
                              ${data.resType || "PROPIETARIO"}
                            </span>
                          </td>
                        `;
                }

                if (resident) {
                  tableHTML += `
                          <td class="text-center align-middle">${resident.name} ${resident.lastname}</td>
                        `;
                } else if (i < maxRows) {
                  tableHTML += `<td class="text-center text-muted">-</td>`;
                }

                if (resident && resident.phone) {
                  const cleanPhone = resident.phone.replace(/\D/g, "");
                  const residentName = resident.name || "";
                  const whatsappMessage = encodeURIComponent(
                    `Hola ${residentName}, le saludamos de Seguridad 24/7 Ecuador.`,
                  );
                  tableHTML += `
                          <td class="text-center">
                            <div class="d-flex align-items-center justify-content-center gap-2">
                              <span style="font-size: 0.85rem;">${resident.phone}</span>
                              <a href="https://wa.me/${cleanPhone}?text=${whatsappMessage}" target="_blank" class="text-success contact-icon">
                                <i class="fa-brands fa-whatsapp"></i>
                              </a>
                              <a href="tel:${resident.phone}" class="text-info contact-icon">
                                <i class="fa-solid fa-phone" style="font-size: 0.8rem;"></i>
                              </a>
                            </div>
                          </td>
                        `;
                } else if (i < maxRows) {
                  tableHTML += `<td class="text-center text-muted">-</td>`;
                }

                // VEHICULO INDIVIDUAL COLUMNS
                if (singleVehicleMultipleResidents && i === 0) {
                  const v = data.vehicles[0];
                  tableHTML += `
                          <td class="text-center fw-bold" rowspan="${maxRows}">${v.brand}</td>
                          <td class="text-center" rowspan="${maxRows}">${v.model}</td>
                          <td class="text-center" rowspan="${maxRows}">${v.color}</td>
                          <td class="text-center text-gold-premium" rowspan="${maxRows}">${v.plate}</td>
                        `;
                } else if (!singleVehicleMultipleResidents) {
                  if (vehicle) {
                    tableHTML += `
                            <td class="text-center fw-bold">${vehicle.brand}</td>
                            <td class="text-center">${vehicle.model}</td>
                            <td class="text-center">${vehicle.color}</td>
                            <td class="text-center text-gold-premium">${vehicle.plate}</td>
                          `;
                  } else if (i < maxRows) {
                    tableHTML += `
                            <td class="text-center text-muted">-</td>
                            <td class="text-center text-muted">-</td>
                            <td class="text-center text-muted">-</td>
                            <td class="text-center text-muted">-</td>
                          `;
                  }
                }

                // ACCIONES
                if (i === 0) {
                  tableHTML += `
                          <td class="text-center align-middle" rowspan="${maxRows}">
                            <div class="d-flex flex-column gap-1">
                              <button class="btn-action-table btn-edit-registry" onclick="abrirEditarRegistro('${data.id}')" title="Editar">
                                <i class="fa-solid fa-pen-to-square"></i>
                              </button>
                              <button class="btn-action-table btn-delete-registry" onclick="eliminarRegistro('${data.id}', '${complexName}')" title="Eliminar">
                                <i class="fa-solid fa-trash-can"></i>
                              </button>
                            </div>
                          </td>
                        `;
                }

                tableHTML += `</tr>`;
              }
            });

            tableHTML += `
                  </tbody>
                </table>
              </div>
            `;

            container.innerHTML = tableHTML;
          } catch (error) {
            console.error("Error al cargar registros:", error);
            container.innerHTML = `
              <div class="alert alert-danger">
                <i class="fa-solid fa-exclamation-triangle me-2"></i>
                Error al cargar los registros. Por favor, intenta de nuevo.
              </div>
            `;
          }
        };

        // --- FUNCIONES PARA EDITAR Y ELIMINAR REGISTROS ---

        window.addResidentEntryEdit = (data = null) => {
          const container = document.getElementById("editResidentsContainer");
          const div = document.createElement("div");
          div.className =
            "p-3 rounded border border-secondary border-opacity-25 position-relative bg-dark bg-opacity-25";
          div.innerHTML = `
            <button type="button" class="btn-close btn-close-white position-absolute end-0 top-0 m-2" onclick="this.parentElement.remove()" style="font-size: 0.6rem;"></button>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label-gold mb-1" style="font-size: 0.65rem;">NOMBRE</label>
                <input type="text" class="form-control resident-name py-1" value="${
                  data ? data.name : ""
                }" required />
              </div>
              <div class="col-6">
                <label class="form-label-gold mb-1" style="font-size: 0.65rem;">APELLIDO</label>
                <input type="text" class="form-control resident-lastname py-1" value="${
                  data ? data.lastname : ""
                }" required />
              </div>
              <div class="col-12">
                <label class="form-label-gold mb-1" style="font-size: 0.65rem;">TELÉFONO</label>
                <input type="tel" class="form-control resident-phone py-1" value="${
                  data ? data.phone : ""
                }" required />
              </div>
            </div>
          `;
          container.appendChild(div);
        };

        window.addVehicleEntryEdit = (data = null) => {
          const container = document.getElementById("editVehiclesContainer");
          const div = document.createElement("div");
          div.className =
            "p-3 rounded border border-secondary border-opacity-25 position-relative bg-dark bg-opacity-25";
          div.innerHTML = `
            <button type="button" class="btn-close btn-close-white position-absolute end-0 top-0 m-2" onclick="this.parentElement.remove()" style="font-size: 0.6rem;"></button>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label-gold mb-1" style="font-size: 0.65rem;">MARCA</label>
                <input type="text" class="form-control v-brand py-1" value="${
                  data ? data.brand : ""
                }" required />
              </div>
              <div class="col-6">
                <label class="form-label-gold mb-1" style="font-size: 0.65rem;">MODELO</label>
                <input type="text" class="form-control v-model py-1" value="${
                  data ? data.model : ""
                }" required />
              </div>
              <div class="col-6">
                <label class="form-label-gold mb-1" style="font-size: 0.65rem;">COLOR</label>
                <input type="text" class="form-control v-color py-1" value="${
                  data ? data.color : ""
                }" required />
              </div>
              <div class="col-6">
                <label class="form-label-gold mb-1" style="font-size: 0.65rem;">PLACA</label>
                <input type="text" class="form-control v-plate py-1" value="${
                  data ? data.plate : ""
                }" required />
              </div>
            </div>
          `;
          container.appendChild(div);
        };

        window.abrirEditarRegistro = async (id) => {
          Swal.fire({
            title: "Cargando datos...",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          try {
            const doc = await db.collection("residents_registry").doc(id).get();
            const data = doc.data();

            document.getElementById("editRegId").value = id;
            document.getElementById("editRegComplexName").value =
              data.complexName;
            document.getElementById("editRegHouseNum").value = data.houseNum;
            document.getElementById("editRegResType").value =
              data.resType || "propietario";

            const residentsContainer = document.getElementById(
              "editResidentsContainer",
            );
            residentsContainer.innerHTML = "";
            if (data.residents && data.residents.length > 0) {
              data.residents.forEach((r) => addResidentEntryEdit(r));
            } else {
              addResidentEntryEdit();
            }

            const vehiclesContainer = document.getElementById(
              "editVehiclesContainer",
            );
            vehiclesContainer.innerHTML = "";
            if (data.vehicles && data.vehicles.length > 0) {
              data.vehicles.forEach((v) => addVehicleEntryEdit(v));
            }

            Swal.close();
            const editModal = new bootstrap.Modal(
              document.getElementById("editRegistryModal"),
            );
            editModal.show();
          } catch (error) {
            console.error("Error al abrir edición:", error);
            Swal.fire("Error", "No se pudieron cargar los datos.", "error");
          }
        };

        window.eliminarRegistro = (id, complexName) => {
          Swal.fire({
            title: "¿Estás seguro?",
            text: "Esta acción eliminará el registro de forma permanente.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#dc3545",
            cancelButtonColor: "#6c757d",
            confirmButtonText: "Sí, eliminar",
            cancelButtonText: "Cancelar",
          }).then(async (result) => {
            if (result.isConfirmed) {
              try {
                await db.collection("residents_registry").doc(id).delete();
                Swal.fire(
                  "¡Eliminado!",
                  "El registro ha sido eliminado.",
                  "success",
                );
                verRegistros(complexName); // Refrescar tabla
              } catch (error) {
                console.error("Error al eliminar registro:", error);
                Swal.fire("Error", "No se pudo eliminar el registro.", "error");
              }
            }
          });
        };

        document
          .getElementById("editRegistryForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = document.getElementById("editRegId").value;
            const complexName =
              document.getElementById("editRegComplexName").value;

            const residents = [];
            document
              .querySelectorAll("#editResidentsContainer > div")
              .forEach((div) => {
                residents.push({
                  name: div
                    .querySelector(".resident-name")
                    .value.trim()
                    .toUpperCase(),
                  lastname: div
                    .querySelector(".resident-lastname")
                    .value.trim()
                    .toUpperCase(),
                  phone: div.querySelector(".resident-phone").value.trim(),
                });
              });

            const vehicles = [];
            document
              .querySelectorAll("#editVehiclesContainer > div")
              .forEach((div) => {
                vehicles.push({
                  brand: div
                    .querySelector(".v-brand")
                    .value.trim()
                    .toUpperCase(),
                  model: div
                    .querySelector(".v-model")
                    .value.trim()
                    .toUpperCase(),
                  color: div
                    .querySelector(".v-color")
                    .value.trim()
                    .toUpperCase(),
                  plate: div
                    .querySelector(".v-plate")
                    .value.trim()
                    .toUpperCase(),
                });
              });

            Swal.fire({
              title: "Actualizando...",
              allowOutsideClick: false,
              didOpen: () => Swal.showLoading(),
            });

            try {
              await db
                .collection("residents_registry")
                .doc(id)
                .update({
                  houseNum: document
                    .getElementById("editRegHouseNum")
                    .value.toUpperCase(),
                  resType: document
                    .getElementById("editRegResType")
                    .value.toUpperCase(),
                  residents,
                  vehicles,
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                });

              Swal.fire(
                "¡Éxito!",
                "Registro actualizado correctamente.",
                "success",
              );
              bootstrap.Modal.getInstance(
                document.getElementById("editRegistryModal"),
              ).hide();
              verRegistros(complexName); // Refrescar tabla
            } catch (error) {
              console.error("Error al actualizar:", error);
              Swal.fire("Error", "No se pudo actualizar el registro.", "error");
            }
          });

        document
          .getElementById("addComplexForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = document
              .getElementById("complexName")
              .value.trim()
              .toUpperCase();
            const isManual =
              document.getElementById("toggleAdminManual").checked;
            const admin = (
              isManual
                ? document.getElementById("complexAdminManual").value.trim()
                : document.getElementById("complexAdmin").value || ""
            ).toUpperCase();
            Swal.fire({
              title: "Guardando...",
              allowOutsideClick: false,
              didOpen: () => Swal.showLoading(),
            });
            try {
              await db.collection("complexes").add({
                name: name,
                admin,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
              Swal.fire(
                "¡Éxito!",
                "El conjunto ha sido registrado correctamente.",
                "success",
              );

              const modal = bootstrap.Modal.getInstance(
                document.getElementById("addComplexModal"),
              );
              modal.hide();

              // Refrescar todos los selects de conjuntos y seleccionar el nuevo
              cargarConjuntosParaSelects(name);

              // Reset UI del admin manual
              document.getElementById("toggleAdminManual").checked = false;
              document.getElementById("adminManualWrapper").style.display =
                "none";
              document.getElementById("adminLinkWrapper").style.display =
                "block";

              e.target.reset();
              $("#complexAdmin").val("").trigger("change");
              cargarConjuntos();
              cargarEstadisticas();
            } catch (error) {
              console.error("Error al guardar:", error);
              Swal.fire("Error", "No se pudo registrar.", "error");
            }
          });

        window.ingresarConjunto = (id, name) => {
          Swal.fire({
            title: "Accediendo...",
            text: `Ingresando al sistema de monitoreo de ${name}`,
            icon: "info",
            timer: 2000,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading(),
          }).then(() => {
            // Aquí podrías redirigir a una página de monitoreo real o abrir un panel específico
            Swal.fire(
              "Acceso Exitoso",
              `Conectado al servidor de video de ${name}`,
              "success",
            );
          });
        };

        window.eliminarConjunto = (id) => {
          Swal.fire({
            title: "¿Eliminar?",
            text: "No se puede deshacer.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d4af37",
            confirmButtonText: "Sí, eliminar",
          }).then(async (result) => {
            if (result.isConfirmed) {
              try {
                await db.collection("complexes").doc(id).delete();
                Swal.fire("Eliminado", "Borrado con éxito.", "success");
                cargarConjuntos();
                cargarEstadisticas();
              } catch (error) {
                console.error("Error al eliminar:", error);
                Swal.fire("Error", "No se pudo eliminar.", "error");
              }
            }
          });
        };

        // --- GESTIÓN DE CLAVES (SÓLO LECTURA) ---
        window.cargarClavesTecnicas = async () => {
          const container = document.getElementById("passwordsContainer");
          if (!container) return;
          container.innerHTML = `<p class="text-center text-white w-100">Cargando claves...</p>`;

          try {
            const query = await db
              .collection("device_passwords")
              .orderBy("complexName", "asc")
              .get();

            window.allPasswords = [];
            query.forEach((doc) => {
              window.allPasswords.push({ id: doc.id, ...doc.data() });
            });

            window.passwordsLoaded = true;
            renderClavesTecnicas(window.allPasswords);
          } catch (error) {
            console.error("Error al cargar claves:", error);
            container.innerHTML = `<p class="text-center text-danger w-100">Error al cargar las claves.</p>`;
          }
        };

        window.renderClavesTecnicas = (passwordsList) => {
          const container = document.getElementById("passwordsContainer");
          if (!container) return;
          container.innerHTML = "";

          if (passwordsList.length === 0) {
            container.innerHTML = `<p class="text-center text-white-50 w-100 mt-4">No se encontraron registros.</p>`;
            return;
          }

          passwordsList.forEach((pass) => {
            container.innerHTML += `
              <div class="col-md-6 col-lg-4">
                <div class="stat-card d-block h-100" style="padding: 25px; transform: none !important;">
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                      <h5 class="text-gold mb-1" style="font-weight: 700;">${
                        pass.complexName
                      }</h5>
                      <span class="badge bg-gold">Gestión Técnica</span>
                    </div>
                  </div>

                  <div class="bg-dark p-3 rounded mb-0" style="background: rgba(0,0,0,0.3) !important; border: 1px solid rgba(212,175,55,0.1);">
                    <div class="row g-2">
                      <div class="col-6">
                        <span class="text-white-50 x-small d-block">Citófono:</span>
                        <span class="text-white small font-monospace">${
                          pass.citofono || "---"
                        }</span>
                      </div>
                      <div class="col-6">
                        <span class="text-white-50 x-small d-block">DVR:</span>
                        <span class="text-white small font-monospace">${
                          pass.dvr || "---"
                        }</span>
                      </div>

                      <div class="col-12 border-top border-secondary my-2" style="opacity: 0.2;"></div>

                      <div class="col-6 border-end border-secondary pe-2" style="border-right-color: rgba(255,255,255,0.1) !important;">
                        <div class="mb-2">
                          <span class="text-white-50 x-small d-block">Wifi: ${
                            pass.wifiName || "N/A"
                          }</span>
                          <span class="text-gold small font-monospace">${
                            pass.wifiPass || "---"
                          }</span>
                        </div>
                        <div>
                          <span class="text-white-50 x-small d-block">Cámaras (${
                            pass.camBrand || "N/A"
                          }):</span>
                          <span class="text-white small font-monospace">${
                            pass.camPass || "---"
                          }</span>
                        </div>
                      </div>

                      <div class="col-6 ps-2">
                        <span class="text-white-50 x-small d-block">Observaciones:</span>
                        <div class="text-white-50 x-small" style="line-height:1.2; font-style: italic;">
                          ${
                            pass.notes ||
                            '<span class="text-muted">Sin notas</span>'
                          }
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          });
        };

        // --- GESTIÓN DE TRABAJOS (CRUD) ---
        window.allTrabajos = [];

        window.cargarTrabajos = async () => {
          const container = document.getElementById("jobsContainer");
          if (!container) return;
          container.innerHTML = `<p class="text-center text-white w-100">Cargando trabajos...</p>`;

          try {
            const query = await db
              .collection("trabajos")
              .orderBy("createdAt", "desc")
              .get();
            window.allTrabajos = [];
            query.forEach((doc) => {
              const data = doc.data();
              if (!data.isGuide) {
                window.allTrabajos.push({ id: doc.id, ...data });
              }
            });
            renderTrabajos(window.allTrabajos);
          } catch (error) {
            console.error("Error al cargar trabajos:", error);
            container.innerHTML = `<p class="text-center text-danger w-100">Error al cargar los trabajos.</p>`;
          }
        };

        window.renderTrabajos = (trabajosList) => {
          const container = document.getElementById("jobsContainer");
          if (!container) return;
          container.innerHTML = "";

          if (trabajosList.length === 0) {
            container.innerHTML = `<p class="text-center text-white-50 w-100 mt-4">No se encontraron trabajos.</p>`;
            return;
          }

          trabajosList.forEach((job) => {
            const urgencyClass =
              job.jobUrgency === "Normal"
                ? "badge-normal"
                : job.jobUrgency === "Urgente"
                  ? "badge-urgente"
                  : "badge-critico";

            container.innerHTML += `
              <div class="col-xl-4 col-md-6">
                <div class="job-card">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="text-gold mb-0 fw-bold">${job.clientName}</h5>
                    <span class="badge ${urgencyClass}">${job.jobUrgency}</span>
                  </div>
                  <div class="job-divider"></div>
                  <div class="mb-3 small">
                    <p class="mb-1"><i class="fa-solid fa-calendar-day text-gold me-2"></i><strong>Fecha:</strong> ${
                      job.jobDate
                    }</p>
                    <p class="mb-1"><i class="fa-solid fa-user-tag text-gold me-2"></i><strong>Contacto:</strong> ${
                      job.contactName
                    }</p>
                    <p class="mb-1"><i class="fa-solid fa-phone text-gold me-2"></i><strong>Teléfono:</strong> ${
                      job.contactPhone
                    }</p>
                    <p class="mb-0"><i class="fa-solid fa-circle-info text-gold me-2"></i><strong>Estado:</strong> <span class="fw-bold">${
                      job.status || "Pendiente"
                    }</span></p>
                  </div>

                  <div class="row g-2">
                    <div class="col-6">
                      <button class="btn-edit" onclick="abrirEditarTrabajo('${
                        job.id
                      }')">
                        <i class="fa-solid fa-pen-to-square me-1"></i> Editar
                      </button>
                    </div>
                    <div class="col-6">
                      <button class="btn-delete" onclick="eliminarTrabajo('${
                        job.id
                      }')">
                        <i class="fa-solid fa-trash me-1"></i> Borrar
                      </button>
                    </div>

                    ${
                      job.status === "Culminado"
                        ? `
                    <div class="col-12">
                      <button class="btn-view-report" onclick="verReporteTrabajo('${job.id}')">
                        <i class="fa-solid fa-file-lines me-1"></i> Ver Reporte
                      </button>
                    </div>
                    `
                        : ""
                    }
                  </div>
                </div>
              </div>
            `;
          });
        };

        // Helper: Resize Image to Base64 (Fallback for CORS)
        const resizeImage = (file, maxWidth = 800, quality = 0.7) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
              const img = new Image();
              img.src = event.target.result;
              img.onload = () => {
                const canvas = document.createElement("canvas");
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) {
                  height *= maxWidth / width;
                  width = maxWidth;
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL(file.type, quality));
              };
              img.onerror = (error) => reject(error);
            };
            reader.onerror = (error) => reject(error);
          });
        };

        // WhatsApp Notification Function
        window.notificarWhatsappTrabajo = (id) => {
          const job = window.allTrabajos.find((j) => j.id === id);
          if (!job) return;

          const message =
            `🔔 *NUEVA ASIGNACIÓN TÉCNICA*\n\n` +
            `📋 *Cliente:* ${job.clientName}\n` +
            `📅 *Fecha:* ${job.jobDate}\n` +
            `🚨 *Urgencia:* ${job.jobUrgency}\n` +
            `👤 *Contacto:* ${job.contactName}\n` +
            `📞 *Teléfono:* ${job.contactPhone}\n\n` +
            `👉 *Por favor, revisa el portal de técnicos para más detalles y gestionar la orden.*`;

          const encodedMessage = encodeURIComponent(message);
          window.open(`https://wa.me/?text=${encodedMessage}`, "_blank");
        };

        // CRUD Actions
        document
          .getElementById("addJobForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();

            const clientName = document
              .getElementById("clientName")
              .value.toUpperCase();
            const jobDate = document.getElementById("jobDate").value;
            const jobUrgency = document.getElementById("jobUrgency").value;
            const contactName = document
              .getElementById("contactName")
              .value.toUpperCase();
            const contactPhone = document.getElementById("contactPhone").value;
            const jobDescription =
              document.getElementById("jobDescription").value; // Capture Description
            const jobImageFile = document.getElementById("jobImage").files[0]; // Capture Image File

            Swal.fire({
              title: "Guardando...",
              text: "Procesando información e imagen...",
              allowOutsideClick: false,
              didOpen: () => Swal.showLoading(),
            });

            try {
              let jobImageUrl = "";

              // Convert image to Base64 and save to Firestore Database
              if (jobImageFile) {
                console.log("📸 Procesando imagen:", jobImageFile.name);
                try {
                  console.log("🔄 Convirtiendo imagen a Base64...");
                  jobImageUrl = await resizeImage(jobImageFile);
                  console.log(
                    "✅ Imagen convertida a Base64 (tamaño:",
                    jobImageUrl.length,
                    "caracteres)",
                  );
                } catch (resizeError) {
                  console.error("❌ Error al procesar imagen:", resizeError);
                  Swal.fire({
                    icon: "warning",
                    title: "Advertencia",
                    text: "No se pudo procesar la imagen. El trabajo se guardará sin imagen.",
                    timer: 2000,
                    showConfirmButton: false,
                  });
                  jobImageUrl = "";
                }
              }

              console.log("💾 Guardando trabajo en Firestore Database...");
              const jobData = {
                clientName,
                jobDate,
                jobUrgency,
                contactName,
                contactPhone,
                jobDescription,
                jobImageUrl,
                status: "Pendiente",
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              };

              console.log("📋 Datos a guardar:", {
                ...jobData,
                jobImageUrl: jobImageUrl
                  ? `[${jobImageUrl.substring(0, 50)}...]`
                  : "sin imagen",
              });
              await db.collection("trabajos").add(jobData);
              console.log("✅ Trabajo guardado exitosamente en Firestore");

              Swal.fire({
                icon: "success",
                title: "¡Trabajo Creado!",
                text: "Se procederá a notificar al técnico vía WhatsApp.",
                showConfirmButton: true,
                confirmButtonColor: "#d4af37",
              }).then(() => {
                // Notificación Automática
                let message =
                  `🔔 *NUEVA ASIGNACIÓN TÉCNICA*\n\n` +
                  `📋 *Cliente:* ${jobData.clientName}\n` +
                  `📅 *Fecha:* ${jobData.jobDate}\n` +
                  `🚨 *Urgencia:* ${jobData.jobUrgency}\n` +
                  `👤 *Contacto:* ${jobData.contactName}\n` +
                  `📞 *Teléfono:* ${jobData.contactPhone}\n` +
                  `📝 *Problema:* ${jobDescription}\n`;

                if (jobImageUrl) {
                  if (jobImageUrl.startsWith("http")) {
                    message += `🖼️ *Foto del Problema:* ${jobImageUrl}\n\n`;
                  } else {
                    message += `🖼️ *Foto del Problema:* (Adjunta en el reporte del sistema)\n\n`;
                  }
                } else {
                  message += `\n`;
                }

                message += `👉 *Por favor, revisa el portal de técnicos para más detalles y gestionar la orden.*`;

                window.open(
                  `https://wa.me/?text=${encodeURIComponent(message)}`,
                  "_blank",
                );
              });

              e.target.reset();
              bootstrap.Modal.getInstance(
                document.getElementById("addJobModal"),
              ).hide();
              cargarTrabajos();
            } catch (error) {
              console.error(error);
              Swal.fire("Error", "No se pudo crear el trabajo.", "error");
            }
          });

        window.abrirEditarTrabajo = async (id) => {
          const doc = await db.collection("trabajos").doc(id).get();
          if (!doc.exists) return;
          const data = doc.data();
          document.getElementById("editJobId").value = id;
          document.getElementById("editClientName").value = data.clientName;
          document.getElementById("editJobDate").value = data.jobDate;
          document.getElementById("editJobUrgency").value = data.jobUrgency;
          document.getElementById("editContactName").value = data.contactName;
          document.getElementById("editContactPhone").value = data.contactPhone;
          new bootstrap.Modal(document.getElementById("editJobModal")).show();
        };

        document
          .getElementById("editJobForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = document.getElementById("editJobId").value;
            const updatedData = {
              clientName: document
                .getElementById("editClientName")
                .value.toUpperCase(),
              jobDate: document.getElementById("editJobDate").value,
              jobUrgency: document.getElementById("editJobUrgency").value,
              contactName: document
                .getElementById("editContactName")
                .value.toUpperCase(),
              contactPhone: document.getElementById("editContactPhone").value,
            };

            Swal.fire({
              title: "Actualizando...",
              allowOutsideClick: false,
              didOpen: () => Swal.showLoading(),
            });

            try {
              await db.collection("trabajos").doc(id).update(updatedData);
              Swal.fire("¡Éxito!", "Trabajo actualizado.", "success");
              bootstrap.Modal.getInstance(
                document.getElementById("editJobModal"),
              ).hide();
              cargarTrabajos();
            } catch (error) {
              console.error(error);
              Swal.fire("Error", "No se pudo actualizar.", "error");
            }
          });

        window.eliminarTrabajo = (id) => {
          Swal.fire({
            title: "¿Eliminar trabajo?",
            text: "Esta acción no se puede deshacer.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d4af37",
            confirmButtonText: "Sí, eliminar",
          }).then(async (result) => {
            if (result.isConfirmed) {
              await db.collection("trabajos").doc(id).delete();
              Swal.fire("Eliminado", "El trabajo ha sido borrado.", "success");
              cargarTrabajos();
            }
          });
        };

        window.verReporteTrabajo = async (id) => {
          Swal.fire({
            title: "Cargando reporte...",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });
          try {
            const doc = await db.collection("trabajos").doc(id).get();
            const data = doc.data();

            const completionDateTime = data.reportDate.toDate();
            document.getElementById("reportClientName").innerText =
              data.clientName;
            document.getElementById("reportJobDate").innerText = data.jobDate;
            document.getElementById("reportStatus").innerText = data.status;
            document.getElementById("reportDate").innerText =
              completionDateTime.toLocaleDateString();
            document.getElementById("reportTime").innerText =
              completionDateTime.toLocaleTimeString();
            document.getElementById("reportText").innerText = data.report;
            document.getElementById("reportImage1").src =
              data.evidenceBase64 && data.evidenceBase64[0]
                ? data.evidenceBase64[0]
                : "";
            document.getElementById("reportImage2").src =
              data.evidenceBase64 && data.evidenceBase64[1]
                ? data.evidenceBase64[1]
                : "";

            // Populate Initial Problem Section
            const problemSection = document.getElementById(
              "initialProblemSection",
            );
            const problemDesc = document.getElementById(
              "reportProblemDescription",
            );
            const problemImg = document.getElementById("reportProblemImage");

            if (data.jobDescription || data.jobImageUrl) {
              problemSection.style.display = "block";
              problemDesc.innerText =
                data.jobDescription || "Sin descripción detallada.";

              if (data.jobImageUrl) {
                document.getElementById(
                  "reportProblemImageContainer",
                ).style.display = "block";
                problemImg.src = data.jobImageUrl;
              } else {
                document.getElementById(
                  "reportProblemImageContainer",
                ).style.display = "none";
                problemImg.src = "";
              }
            } else {
              problemSection.style.display = "none";
            }

            // Manejar Firmas
            const signaturesSection = document.getElementById(
              "reportSignaturesSection",
            );
            const signatureImg = document.getElementById(
              "reportClientSignature",
            );
            if (data.clientSignature) {
              signatureImg.src = data.clientSignature;
              signaturesSection.style.display = "block";
            } else {
              signatureImg.src = "";
              signaturesSection.style.display = "none";
            }

            Swal.close();
            new bootstrap.Modal(document.getElementById("reportModal")).show();
          } catch (error) {
            console.error(error);
            Swal.fire("Error", "No se pudo cargar el reporte.", "error");
          }
        };

        // PDF Generation Logic (Modern & Elegant Style)
        document
          .getElementById("generateJobPdfBtn")
          .addEventListener("click", () => {
            const btn = document.getElementById("generateJobPdfBtn");
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML =
              '<i class="fa-solid fa-spinner fa-spin me-2"></i> GENERANDO...';

            if (typeof window.generateModernPDF === "function") {
              window
                .generateModernPDF()
                .then(() => {
                  Swal.fire({
                    icon: "success",
                    title: "PDF Generado",
                    text: "El reporte se ha descargado correctamente.",
                    timer: 2000,
                    showConfirmButton: false,
                  });
                })
                .catch((err) => {
                  console.error("PDF Generation Error:", err);
                  Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: "Hubo un error al generar el PDF.",
                  });
                })
                .finally(() => {
                  btn.disabled = false;
                  btn.innerHTML = originalText;
                });
            } else {
              console.error("generateModernPDF function not found!");
              Swal.fire(
                "Error",
                "La función de generar PDF no está disponible.",
                "error",
              );
              btn.disabled = false;
              btn.innerHTML = originalText;
            }
          });

        // Filtros de trabajos
        document
          .getElementById("jobUrgencyFilter")
          .addEventListener("change", (e) => {
            const val = e.target.value;
            const search = document
              .getElementById("jobSearchInput")
              .value.toLowerCase();
            const filtered = window.allTrabajos.filter(
              (j) =>
                (val === "todas" || j.jobUrgency === val) &&
                j.clientName.toLowerCase().includes(search),
            );
            renderTrabajos(filtered);
          });

        document
          .getElementById("jobSearchInput")
          .addEventListener("input", (e) => {
            const val = e.target.value.toLowerCase();
            const urgency = document.getElementById("jobUrgencyFilter").value;
            const filtered = window.allTrabajos.filter(
              (j) =>
                (urgency === "todas" || j.jobUrgency === urgency) &&
                j.clientName.toLowerCase().includes(val),
            );
            renderTrabajos(filtered);
          });

        const passwordSearchInput = document.getElementById(
          "passwordSearchInput",
        );
        if (passwordSearchInput) {
          passwordSearchInput.addEventListener("input", (e) => {
            const val = e.target.value.toLowerCase();
            const filtered = window.allPasswords.filter(
              (p) =>
                p.complexName.toLowerCase().includes(val) ||
                (p.wifiName && p.wifiName.toLowerCase().includes(val)),
            );
            renderClavesTecnicas(filtered);
          });
        }

        const handleLogout = () => {
          Swal.fire({
            title: "¿Cerrar Sesión?",
            text: "Estás por salir.",
            icon: "question",
            showCancelButton: true,
            confirmButtonColor: "#ff4444",
          }).then((result) => {
            if (result.isConfirmed)
              auth
                .signOut()
                .then(() => (window.location.href = "control_center.html"));
          });
        };

        const logoutBtn = document.getElementById("logoutBtn");
        const logoutBtnMobile = document.getElementById("logoutBtnMobile");
        if (logoutBtn) logoutBtn.addEventListener("click", handleLogout);
        if (logoutBtnMobile)
          logoutBtnMobile.addEventListener("click", handleLogout);

        const sidebarToggle = document.getElementById("sidebarToggle");
        const sidebar = document.getElementById("sidebar");
        if (sidebarToggle) {
          sidebarToggle.addEventListener("click", () => {
            sidebar.classList.toggle("show");
          });
        }

        // Cerrar sidebar al hacer clic en un link (móvil)
        document.querySelectorAll(".sidebar-link").forEach((link) => {
          link.addEventListener("click", () => {
            if (window.innerWidth < 992) {
              sidebar.classList.remove("show");
            }
          });
        });

        // Function to open image in fullscreen (Unified with admin)
        window.openImageFullscreen = function (imageUrl) {
          if (!imageUrl || imageUrl === window.location.href) return;

          Swal.fire({
            imageUrl: imageUrl,
            imageAlt: "Imagen Ampliada",
            showConfirmButton: false,
            showCloseButton: true,
            background: "#000",
            backdrop: "rgba(0,0,0,0.95)",
            customClass: {
              image: "fullscreen-image-modal",
            },
            width: "90%",
            padding: "20px",
          });
        };
      });
    </script>
  </body>
</html>
